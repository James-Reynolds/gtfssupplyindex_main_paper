---
title: "Leveraging GTFS to explore spatial patterns in transit supply with respect to social needs"
author:
  - name: James Reynolds
    email: james.reynolds@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    correspondingauthor: false
    footnote: 1
  - name: Yanda Qu
    email: yanda.qu@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    footnote: 2
  - name: Graham Currie
    email: graham.currie@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    correspondingauthor: true
    footnote: 3
address:
  - code: Public Transport Research Group (PTRG)
    organization: Public Transport Research Group (PTRG), Institute of Transport Studies, Department of Civil Engineering Engineering, Monash University
    addressline: Clayton Campus
    city: Melbourne 
    state: Victoria
    postcode: 3800
    country: Australia
  
footnote:
  - code: 1
    text: "Research Fellow"
  - code: 2
    text: "PhD Student"
  - code: 3
    text: "Professor"
abstract: |
  This is the abstract.

  It consists of two paragraphs.
keywords: 
  - keyword1
  - keyword2
journal: "Transport Geography?"
date: "`r Sys.Date()`"
classoption: preprint, 3p, authoryear
bibliography: References.bib, packages.bib
linenumbers: false
numbersections: true
# Use a CSL with `citation_package = "default"`
# csl: https://www.zotero.org/styles/elsevier-harvard
output: 
  rticles::elsevier_article:
    keep_tex: true
    citation_package: natbib
    extra_dependencies: "subfig"
---



```{r setup, include=FALSE}
library(tidyverse)
library(tidytransit)
library(sp)
library(strayr)
library(ptinpoly)
library(magrittr)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(janitor)
library(mapview)
library(ggstatsplot)
library(gtsummary)
library(moments)
library(scales)
library(gtfstools)
library(lubridate)
library(kableExtra)
library(knitr)
library(readxl)
library(dplyr)
library(devtools)
library(gtfssupplyindex)
library(readabs)
library(gglorenz)
library(DescTools)
library(RColorBrewer)
library(lsr)
library(ggpubr)

# invalidate cache when the tufte version changes
#knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))

```



# Introduction

The spatial distribution 
of transport disadvantage, 
gaps in transit supply and 
accessibility, and related issues 
have been a focus of previous research^[See for example
@Ricciardi2015
@Currie2003Hobart; @currie2010identifying; @Fransen2015Identifying;
@Guzman2017Assessing; @Jaramillo2012; @Preston2007; @Delbosc2011Transportproblems; 
@Delbosc2011Thespatial; 
@Engels2011Social;
@Pavkova2016; @Delbosc2011Using; 
@Murray2001; @Currie2010Modeling;
@Currie2007Investigating; 
@Currie2007Identifying;
@Yigitcanlar2007;
@Wu2003; 
@Currie2013Exploring;
@Preston2007Accessibility;
@Hurni2005; 
@Mamun2011; 
@El_geneidy2016;
@Kaplan2014;
@Martens2012;
@Lucas2016AMethod;
@Liu2012Accessibility;
@Lucas2012Transport_and_social;
@Lei2010Mapping;
@Mavoa2012GIS;
@Delmelle2012Evaluating;
@Foth2014Toward; 
@Welch2013Equity; 
@Bell2007Travel;
@Jaramillob2011Urban;
@Guzman2017Assessing; 
@Wee2011Discussing;
@Currie2004Gap;
@Engels2011Social; 
@Litman2002Evaluation;
@Parolin2017Identifying;
@Xia2016AMulti;
@Welch2013AMeasure;
@Jang2017Assessing.]. 
Much of this presents
methodologies for calculating 
social needs and 
transit supply 
so as 
to locate areas where
people who most need 
public transportation 
are not getting it.
However, such methodologies 
appear to only rarely be revisited, 
reused or otherwise 
applied to other cases 
or time periods in subsequent research. 
This may in part be because 
applying an existing methodology 
to another location or time period 
might not generate sufficient 
'new' knowledge for publication, 
and/or be more an activity for 
practitioners than for researchers. 
As well, describing a new methodology 
in a research paper might only require 
presentation of 
enough results to demonstrate the concepts, 
rather than widespread application to multiple 
geographic contexts, 
which might necessitate 
the development 
of software tools to facilitate 
broader usage.  

An example is provided by 
the @Currie2003Hobart, 
@Currie2004Gap, 
@Currie2007Identifying, @currie2010identifying
studies on spatial gaps between the social need for transport and the supplied transit levels. 
This work presented a transit Supply Index (SI) 
and compared it to measures of social need for transport across a few Australian cities.  
But there does not appear to have been much further use 
of this approach in research or practice. 
It is unclear whether the 
gaps identified in this previous research 
have become narrower or being resolved 
in the almost two decades since the original analysis. 
Nor is it clear whether the identified spatial patterns 
of transit need, supply and gaps 
are generalizable to other places, 
beyond Hobart [@Currie2003Hobart; @Currie2004Gap] 
and Melbourne [@Currie2007Identifying; @currie2010identifying].  
This is perhaps in part because
at the time it was first published
the data needed to calculate the
transit Supply Index (SI) for a particular location 
was not typically readily available.
The @currie2010identifying 
analysis of Melbourne was based on combining 
multiple operator databases and
service frequency data 
that had been manually extracted from 
transit agency websites. 
To apply the methodology elsewhere 
would appear likely to have required 
a bespoke data collection, 
cleaning and analysis effort. Nowadays, however, 
the General Transit Feed Specification (GTFS)
allows timetable data to be published in a standardized format. 
More than 10,000 transit agencies release data 
this way [@GTFS]. 

Various tools for analysing GTFS data are now available,
but there does not appear to have been 
many developed to allow the analysis of 
spatial gaps between the social need for transport and 
the amount of transit that is supplied. 
While the previous literature provides a 
wealth of methodologies, 
the availability of tools 
that might be used by researchers, 
practitioners 
and advocates to 
use these 
approaches with GTFS data 
relatively easily 
appears limited.  

This gap provides the motivation 
for the research reported in this paper, 
in which a new R package (gtfssupplyindex) 
specifically developed to calculate SI scores 
is presented. 
The paper also reports results for Greater Melbourne in 2016 and 2021, 
matching the most recent censuses 
and allowing comparison to the 2006 result reported in  @currie2010identifying.
Comparisons are also made to other parts of Australia, 
so as to explore whether findings about Greater Melbourne are generalizable. 

The remainder of this paper is structured as follows:
the next section outlines the background to this research,
including the formulation of the Transit Supply Index (SI), 
and an explanation of the GTFS. 
Section 3 then describes the study methodology, 
followed by presentation of results in Section 4. 
Section 5 discusses the results and the limitations of this study,
and outlines directions for future research. 
A brief conclusion is provided in Section 6. 

# Background

## Transit metrics
Even a brief search reveals 
many metrics 
available for benchmarking transit services. 
Examples include those in: 
the extensive Transit Cooperative Research Program (TCRP) Report 88 guidebook 
on developing performance-measurement systems [@Ryus:2003aa]; 
and those used across
benchmarking databases and programs [@Florida-Transit-Information-System:2018aa; @UITP:2015aa; @Imperial-College-London:2023aa].
The Fielding Triangle [@FieldingGordonJ1987Mpts] 
provides a framework 
for combining indicators of 
service inputs, 
outputs 
and consumption 
to describe cost efficiency, 
cost effectiveness and
service effectiveness. 
More broadly: @Litman:2003ab 
and @Litman:2016aa 
discuss some of the traffic, 
mobility, 
accessibility, 
social equity, 
strategic planning 
and other rational decision-making-based
perspectives underling transport indicators; 
@Reynolds:2017ah extends 
these into models of how 
institutionalism, 
incrementalism 
and other public policy analysis concepts 
might apply to decision-making processes 
relating to transit prioritization; 
@GuzmanLuisA.2017Aeit, 
developed a measure of accessibility 
in the context of policy development 
and social equity 
for Latin American Bus Rapid Transit (BRT) networks; and 
@Creutzig2020streetspaceallocation
introduced street space allocation metrics 
based around 10 ethical principles. 

However, 
many of these, and other, transit metrics 
may be difficult to calculate, and/or
complex to explain or understand, 
especially for those who are not planners, engineers 
or other technical specialists. 
Where pre-calculated metrics 
are immediately available 
it may not be possible for practitioners, 
researchers 
or advocates 
to independently generate scores 
so as to test proposed system changes, 
or demonstrate impacts to politicans, 
the general public or others. 
Contrasting examples are provided by the metrics in the 
Transit Capacity and Quality of Service Manual (TCQSM) 
and the Transit Score metric [@WalkScore:2023tg]. 
Transit Scores are readily available on the Transit Score website for locations with a published GTFS feed. 
The meaning of these Transit Scores 
also appears easy to explain, 
with the highest possible score of 100 
representing the sort of transit accessibility that might be xperienced in the center of New York. 
However, 
the Transit Score algorithm 
is a black box, 
and cannot be calculated independently
or generated 
for proposed changes to networks. 
In contrast, the TCQSM provides a wide range of metrics 
for measuring different aspects of a transit system. 
The TCQSM scores themselves appear easy to understand or explain, 
ranging from A (good) to F (bad), 
and these can be calculated independently, given sufficient data. 
@Wong:2013aa provides an example of what can be done 
combining GTFS data with metrics that can be independently calculating, 
reporting TCQSM scores across 50 transit operators. 

The GTFS
is an open, 
text-based format, 
developed originally to allow transit 
to be included in the Google Maps navigation platform [@GTFS]. 
Figure \@ref(fig:GTFS_ERD) shows 
an Entity Relationship Diagram (ERD) 
of the GTFS structure, 
indicatating how data 
is stored as a series of tables 
(agency, routes, trips etc.) 
linked by primary and foreign keys (agency_id, route_id, trip_id etc.).
While there are many software tools for 
analyzing, visualizing or otherwise manipulating GTFS data, 
one to calculate Transit Supply Index (SI) scores is not yet available.



```{r GTFS_ERD, crop = TRUE, fig.cap = "GTFS entity relationship diagram. Source: adapted by author from Alamri et al (2023) and the GTFS Schedule Reference (16/11/2023 revision).", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
knitr::include_graphics("graphics/GTFS.png")

```


## The Transit Suppy Index
A generalized form of the SI equation, adapted from @currie2010identifying, is: 

  $$SI_{area, time} = \sum{\frac{Area_{Bn}}{Area_{area}}*SL_{n, time}}$$

where:

- $SI_{area, time}$ is the Supply Index for the area of interest 
and a given period of time;

- $Area_{Bn}$ is the buffer area for each stop (n) within the area of interest 
(in @currie2010identifying this was based on 
a radius of 400 metres for bus and tram stops, 
and 800 metres for railway stations);

- $Area_{area}$ is the area of the area of interest; and

- $SL_{n,time}$ is the number of transit arrivals for each stop 
for a given time period.

```{r Currie_map_SI, fig.cap = "Distribution of supply measure scores – Metropolitan Melbourne (2006), Source: Currie (2010)",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/Currie2010SI.png")

```

@currie2010identifying reported SI scores across Greater Melbourne in 2006, as shown in 
Figure \ref{fig:Currie_map_SI}.
The general patterns appear to be 
higher levels of transit supply 
in the middle and inner suburbs
and along passenger railway lines. 
Outer areas tend to have very low SI scores 
or no transit supply at all. 

## Social need and needs gap

As well as measuring transit supply, @currie2010identifying also 
assessed the social need for transit 
across Greater Melbourne using: 
the Australian Bureaus of Statistics' Index of Related Socio-Economic Advantage/Disadvantage (IRSAD); 
a transport needs index derived by @currie2010identifying
from eight weighted indicators; 
and a combination of the two. Figures  \ref{fig:Currie_chart_gap} and \ref{fig:Currie_map_gap} reproduce the resultant chart and map 
combining needs and supply to identify gaps. 


```{r Currie_chart_gap, fig.cap = "Log supply score and need index values – Melbourne needs-gap study, Source: Currie (2010)",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/Currie2010chart.png")

```


```{r Currie_map_gap, fig.cap = "Melbourne needs-gap – very high transport need areas with zero or very low public transport supply, Source: Currie (2010)",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/Currie2010gap.png")

```

The results indicated service gaps of concern, 
especially in outer parts of Melbourne 
where low density development patterns 
make provision of transit more challenging. 
@currie2010identifying found that 
"(o)verall, 8.2% of Melbourne residents have ‘very high’ needs 
but ‘zero’, ‘low’ or ‘very low’ public transport supply."  
They also suggested that 
planning for transit service provision 
using this approach would be
"substantially more useful than the presentation of anecdotal evidence, 
which is the most common means 
of identifying transport needs 
in local transport studies throughout the world."
However, it doesn't appear that this approach has been widely adopted 
in practice or academia. 
Our suspicion is that while the SI has a relatively simple formula 
and requires only geographic and timetable data, 
the lack of a software tool to perform these calculations
may be part of the reason 
that it has not been more widely adopted 
and why formal needs-supply-gap analysis may still be uncommon.  

It is also unclear whether the patterns in Melbourne 
identified in @currie2010identifying, 
where areas with very high transport needs 
but zero or very low transit supply 
tend to be in outer areas serviced by buses, 
are similar to patterns in other cities. 
Nor is it clear whether the patterns in Melbourne itself have changed 
since the 2006 analysis. 
Developing a software tool 
to calculate SI tools from GTFS data, 
and then using it to comparing current conditions and other locations 
to the findings of @currie2010identifying, 
therefore, is the primary aim of this paper.  


# Methodology
This study developed
a package of tools 
for calculating the SI from GTFS data 
using the R programming language [@R-base].
The recommendations of @wickham2023r 
informed the package setup and 
development approach. 
Various existing packages 
were relied upon including: 
the sf package [@R-sf] for geospatial analysis; 
the tidyverse [@tidyverse2019]; 
gtfstools [@R-gtfstools]; and 
tidytransit [@R-tidytransit]. 
Australian Bureau of Statistics (ABS) data was also used, sourced via the strayr 
and absmapsdata packages [@r-strayr].
Some code was adapted from 
examples, vignettes and other documentation 
in these and other packages.

Two cases were used 
during the code development and testing, 
such that results might be generated for real GTFS data: 
the Mornington Peninsula Tourist Railway GTFS feed; 
and the Public Transport Victoria (PTV) GTFS feed, 
both in Victoria, Australia. 
Both were selected primarily for convenience, 
given that the authors are familiar with 
the typical service patterns and geography.
Adopting the Mornington Peninsula Tourist Railway network, which consists of only three stations, 
also facilitated hand calculation of the SI 
as a cross-check of the results 
produced by the developed package. 

Figure \@ref(Melbourne_map)) shows the areas of interest 
relevant to the code development and testing, 
and selected railway stations. 
Statistical Area (SA) zones were adopted 
from the Australian Bureau of Statistics [@ABSmaps] 
as the areas of interest, and 
included SA3 zones^[These are generally similar to Local Government Area (LGA) boundaries.]
across the Greater Melbourne Greater Capital City 
statistical area (Figure \@ref(Melbourne_map), left); 
and SA1 zones^[SA1 zones are the smallest geographical areas 
for which results are reported in the Australian census.] within 800 metres of the Mornington Penninsula railway (Figure \@ref(Melbourne_map), right). 
  

```{r Melbourne_map, fig.cap = "Areas of interest",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/all_maps.png")

```
## Mornington Penninsula Tourist Railway

The Morning Peninsula Tourist Railway 
is in the outer south-east of Melbourne, 
running on Sundays and Wednesdays 
between Mornington and Moorooduc, 
with an intermediate stop at Tanti Park^[see https://transitfeeds.com/p/mornington-railway/806/latest/stops].
A GTFS feed from 2018 
was selected for the purposes of tests,
and for demonstrating the code and outputs reported here.

```{r mornington_calc, crop = TRUE, fig.cap = "SA1 zones (red), location of Mornington Tourist Railway Stations (black) and boundary of zones within 800m catchment (blue)", fig.width = 3, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}
### ---------------- get abs data for Mornington Peninsula
#options(timeout = 1000)
#remotes::install_github("wfmackey/absmapsdata")

#get_mornington_sa1 <- function(){
#  mornington_sa12021 <- absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021)
#  sf::st_write(mornington_sa12021, "inst/extdata/mornington_sa12021.geojson", append=FALSE)
#  return(mornington_sa12021)
#}
#get_mornington_sa3 <- function(){
#  mornington_sa32021 <- absmapsdata::sa32021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa3_code_2021)
#  sf::st_write(mornington_sa32021, "inst/extdata/mornington_sa32021.geojson", append=FALSE)
#  return(mornington_sa32021)
#}

### ---------------- load SA3 abs maps data for just mornington peninsula
areas_of_interest <- load_areas_of_interest(areas_of_interest = absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021), 
  area_id_field = "sa1_code_2021")

# map the areas_of_interest
map <- areas_of_interest %>% 
  ggplot() +
  geom_sf(aes(geometry = geometry))
#map
#set the EPSG to transform from lat/lon to metres
EPSG_for_transform = 28355

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))
stops_as_sf_mornington <-  list_gtfs[[1]]$stops %>% 
  tidytransit::stops_as_sf()

#map the stops on the ABS data
#map + 
#  geom_sf(data = stops_as_sf_mornington, aes(geometry = geometry))


stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355
)

```

## Public Transport Victoria (PTV)
The Victorian GTFS feed, 
published by Public Transport Victoria (PTV) and 
with historical feeds sourced via @transitfeeds_victoria:2023aa, was used for analysis of Greater Melbourne and Victoria. SI scores were obtained for the weeks starting on the day of the census in 2016 and 2021, which were on Tuesday 9th and 10th of August respectively. 

```{r fix_ptv_data_Victoria_230804, eval = FALSE, echo = FALSE}


ptv_230804 <- tidytransit::read_gtfs("data/ptv_230804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_230804_duplicated_stops <- tabyl(ptv_230804$stops$stop_id) %>% filter (n>1)
names(ptv_230804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_230804_duplicated_stops <- left_join(ptv_230804_duplicated_stops, ptv_230804$stops)

##discard duplicates
ptv_230804$stops <- ptv_230804$stops[!duplicated(ptv_230804$stops$stop_id),]

## Write gtfs back to file
ptv_230804 <- as_tidygtfs(ptv_230804)
tidytransit::write_gtfs(ptv_230804, "data/ptv_230804/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_all_of_Victoria_230808, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_230808 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230808")

si_by_area_and_hour_230808_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230808_tram")

si_by_area_and_hour_230808_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230808_rail")

si_by_area_and_hour_230808_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230808_bus")

```


```{r run_for_all_modes_all_of_Victoria_230809, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_230809_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230809_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230809_tram")

si_by_area_and_hour_230809_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230809_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230809_rail")

si_by_area_and_hour_230809_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230809_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230809_bus")

```



```{r run_for_all_modes_all_of_Victoria_230810, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_230810_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230810_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230810_tram")

si_by_area_and_hour_230810_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230810_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230810_rail")

si_by_area_and_hour_230810_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230810_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230810_bus")

```


```{r run_for_all_modes_all_of_Victoria_230811, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_230811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230811_tram")

si_by_area_and_hour_230811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230811_rail")

si_by_area_and_hour_230811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230811_bus")

```

```{r run_for_all_modes_all_of_Victoria_230812, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_230812_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230812_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230812_tram")

si_by_area_and_hour_230812_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230812_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230812_rail")

si_by_area_and_hour_230812_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230812_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230812_bus")

```


```{r fix_ptv_data_Victoria_220804, eval = FALSE, echo = FALSE}


ptv_220804 <- tidytransit::read_gtfs("data/ptv_220804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_220804_duplicated_stops <- tabyl(ptv_220804$stops$stop_id) %>% filter (n>1)
names(ptv_220804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_220804_duplicated_stops <- left_join(ptv_220804_duplicated_stops, ptv_220804$stops)

##discard duplicates
ptv_220804$stops <- ptv_220804$stops[!duplicated(ptv_220804$stops$stop_id),]

## Write gtfs back to file
ptv_220804 <- as_tidygtfs(ptv_220804)
tidytransit::write_gtfs(ptv_220804, "data/ptv_220804/gtfs_duplicate_stops_removed.zip")

```

```{r fix_ptv_data_Victoria_210805, eval = FALSE, echo = FALSE}


ptv_210805 <- tidytransit::read_gtfs("data/ptv_210805/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_210805_duplicated_stops <- tabyl(ptv_210805$stops$stop_id) %>% filter (n>1)
names(ptv_210805_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_210805_duplicated_stops <- left_join(ptv_210805_duplicated_stops, ptv_210805$stops)

##discard duplicates
ptv_210805$stops <- ptv_210805$stops[!duplicated(ptv_210805$stops$stop_id),]

## Write gtfs back to file
ptv_210805 <- as_tidygtfs(ptv_210805)
tidytransit::write_gtfs(ptv_210805, "data/ptv_210805/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_210810, eval = FALSE, echo = FALSE}
list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210810")

si_by_area_and_hour_210810_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210810_tram")

si_by_area_and_hour_210810_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210810_rail")

si_by_area_and_hour_210810_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210810_bus")

```


```{r run_for_all_modes_Victoria_210811, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210811_tram")

si_by_area_and_hour_210811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210811_rail")

si_by_area_and_hour_210811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210811_bus")

```


```{r run_for_all_modes_Victoria_210812, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210812_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210812_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210812_tram")

si_by_area_and_hour_210812_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210812_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210812_rail")

si_by_area_and_hour_210812_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210812_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210812_bus")

```


```{r run_for_all_modes_Victoria_210813, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210813_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210813_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210813_tram")

si_by_area_and_hour_210813_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210813_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210813_rail")

si_by_area_and_hour_210813_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210813_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210813_bus")

```


```{r run_for_all_modes_Victoria_210814, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210814_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210814_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210814_tram")

si_by_area_and_hour_210814_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210814_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210814_rail")

si_by_area_and_hour_210814_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210814_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210814_bus")

```


```{r run_for_all_modes_Victoria_210815, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210815_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210815_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210815_tram")

si_by_area_and_hour_210815_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210815_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210815_rail")

si_by_area_and_hour_210815_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210815_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210815_bus")

```


```{r run_for_all_modes_Victoria_210816, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210816_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-16",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210816_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210816_tram")

si_by_area_and_hour_210816_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-16",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210816_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210816_rail")

si_by_area_and_hour_210816_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-16",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210816_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210816_bus")

```



```{r fix_ptv_data_Victoria_200729, eval = FALSE, echo = FALSE}


ptv_200729 <- tidytransit::read_gtfs("data/ptv_200729/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_200729_duplicated_stops <- tabyl(ptv_200729$stops$stop_id) %>% filter (n>1)
names(ptv_200729_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_200729_duplicated_stops <- left_join(ptv_200729_duplicated_stops, ptv_200729$stops)

##discard duplicates
ptv_200729$stops <- ptv_200729$stops[!duplicated(ptv_200729$stops$stop_id),]

## Write gtfs back to file
ptv_200729 <- as_tidygtfs(ptv_200729)
tidytransit::write_gtfs(ptv_200729, "data/ptv_200729/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_200729_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_200729/gtfs_duplicate_stops_removed.zip")

```

```{r run_for_all_modes_Victoria_200811, eval = FALSE, echo = FALSE}

list_gtfs = ptv_200729_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_200811 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811, "results/Greater_Melbourne/si_by_SA12021area_and_hour_200811")

si_by_area_and_hour_200811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_200811_tram")

si_by_area_and_hour_200811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_200811_rail")

si_by_area_and_hour_200811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_200811_bus")

```

```{r fix_ptv_data_Victoria_190802, eval = FALSE, echo = FALSE}
ptv_190802 <- tidytransit::read_gtfs("data/ptv_190802/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_190802_duplicated_stops <- tabyl(ptv_190802$stops$stop_id) %>% filter (n>1)
names(ptv_190802_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_190802_duplicated_stops <- left_join(ptv_190802_duplicated_stops, ptv_190802$stops)

##discard duplicates
ptv_190802$stops <- ptv_190802$stops[!duplicated(ptv_190802$stops$stop_id),]

## Write gtfs back to file
ptv_190802 <- as_tidygtfs(ptv_190802)
tidytransit::write_gtfs(ptv_190802, "data/ptv_190802/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_190802_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_190802/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_190813, eval = FALSE, echo = FALSE}

list_gtfs = ptv_190802_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_190813 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813, "results/Greater_Melbourne/si_by_SA12021area_and_hour_190813")

si_by_area_and_hour_190813_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_190813_tram")

si_by_area_and_hour_190813_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_190813_rail")

si_by_area_and_hour_190813_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_190813_bus")

```

```{r fix_ptv_data_Victoria_180803, eval = FALSE, echo = FALSE}


ptv_180803 <- tidytransit::read_gtfs("data/ptv_180803/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_180803_duplicated_stops <- tabyl(ptv_180803$stops$stop_id) %>% filter (n>1)
names(ptv_180803_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_180803_duplicated_stops <- left_join(ptv_180803_duplicated_stops, ptv_180803$stops)

##discard duplicates
ptv_180803$stops <- ptv_180803$stops[!duplicated(ptv_180803$stops$stop_id),]

## Write gtfs back to file
ptv_180803 <- as_tidygtfs(ptv_180803)
tidytransit::write_gtfs(ptv_180803, "data/ptv_180803/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_180803_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_180803/gtfs_duplicate_stops_removed.zip")


```


```{r run_for_all_modes_Victoria_180814, eval = FALSE, echo = FALSE}


list_gtfs = ptv_180803_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)
si_by_area_and_hour_180814 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814, "results/Greater_Melbourne/si_by_SA12021area_and_hour_180814")

si_by_area_and_hour_180814_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_180814_tram")

si_by_area_and_hour_180814_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_180814_rail")

si_by_area_and_hour_180814_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_180814_bus")

```

```{r fix_ptv_data_Victoria_170804, eval = FALSE, echo = FALSE}


ptv_170804 <- tidytransit::read_gtfs("data/ptv_170804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_170804_duplicated_stops <- tabyl(ptv_170804$stops$stop_id) %>% filter (n>1)
names(ptv_170804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_170804_duplicated_stops <- left_join(ptv_170804_duplicated_stops, ptv_170804$stops)

##discard duplicates
ptv_170804$stops <- ptv_170804$stops[!duplicated(ptv_170804$stops$stop_id),]

## Write gtfs back to file
ptv_170804 <- as_tidygtfs(ptv_170804)
tidytransit::write_gtfs(ptv_170804, "data/ptv_170804/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_170804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_170804/gtfs_duplicate_stops_removed.zip")

```


```{r run_for_all_modes_Victoria_170808, eval = FALSE, echo = FALSE}


list_gtfs = ptv_170804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_170808 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808, "results/Greater_Melbourne/si_by_SA12021area_and_hour_170808")

si_by_area_and_hour_170808_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_170808_tram")

si_by_area_and_hour_170808_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_170808_rail")

si_by_area_and_hour_170808_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_170808_bus")

```

```{r fix_ptv_data_Victoria_160804, eval = FALSE, echo = FALSE}
 

ptv_160804 <- tidytransit::read_gtfs("data/ptv_160804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_160804_duplicated_stops <- tabyl(ptv_160804$stops$stop_id) %>% filter (n>1)
names(ptv_160804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_160804_duplicated_stops <- left_join(ptv_160804_duplicated_stops, ptv_160804$stops)

##discard duplicates
ptv_160804$stops <- ptv_160804$stops[!duplicated(ptv_160804$stops$stop_id),]

## Write gtfs back to file
ptv_160804 <- as_tidygtfs(ptv_160804)
tidytransit::write_gtfs(ptv_160804, "data/ptv_160804/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

```

```{r run_for_all_modes_Victoria_160809, eval = FALSE, echo = FALSE}
list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160809")

si_by_area_and_hour_160809_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160809_tram")

si_by_area_and_hour_160809_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160809_rail")

si_by_area_and_hour_160809_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160809_bus")

```


```{r run_for_all_modes_Victoria_160810, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160810_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160810_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160810_tram")

si_by_area_and_hour_160810_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160810_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160810_rail")

si_by_area_and_hour_160810_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160810_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160810_bus")

```


```{r run_for_all_modes_Victoria_160811, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160811_tram")

si_by_area_and_hour_160811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160811_rail")

si_by_area_and_hour_160811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160811_bus")

```


```{r run_for_all_modes_Victoria_160812, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()


list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160812_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160812_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160812_tram")

si_by_area_and_hour_160812_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160812_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160812_rail")

si_by_area_and_hour_160812_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160812_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160812_bus")

```


```{r run_for_all_modes_Victoria_160813, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160813_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160813_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160813_tram")

si_by_area_and_hour_160813_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160813_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160813_rail")

si_by_area_and_hour_160813_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160813_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160813_bus")

```


```{r run_for_all_modes_Victoria_160814, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160814_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160814_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160814_tram")

si_by_area_and_hour_160814_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160814_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160814_rail")

si_by_area_and_hour_160814_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160814_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160814_bus")

```


```{r run_for_all_modes_Victoria_160815, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160815_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160815_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160815_tram")

si_by_area_and_hour_160815_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160815_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160815_rail")

si_by_area_and_hour_160815_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160815_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160815_bus")

```


```{r fix_ptv_data_Victoria_150729, eval = FALSE, echo = FALSE}


ptv_150729 <- tidytransit::read_gtfs("data/ptv_150729/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_150729_duplicated_stops <- tabyl(ptv_150729$stops$stop_id) %>% filter (n>1)
names(ptv_150729_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_150729_duplicated_stops <- left_join(ptv_150729_duplicated_stops, ptv_150729$stops)

##discard duplicates
ptv_150729$stops <- ptv_150729$stops[!duplicated(ptv_150729$stops$stop_id),]

## Write gtfs back to file
ptv_150729 <- as_tidygtfs(ptv_150729)
tidytransit::write_gtfs(ptv_150729, "data/ptv_150729/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_150729_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_150729/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_150811, eval = FALSE, echo = FALSE}

list_gtfs = ptv_150729_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_150811 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811, "results/Greater_Melbourne/si_by_SA12021area_and_hour_150811")

si_by_area_and_hour_150811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_150811_tram")

si_by_area_and_hour_150811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_150811_rail")

si_by_area_and_hour_150811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_150811_bus")

```

# Results
## Code structure and functionality


Developed code is available and documented on github (see @gtfssupplyindex_github). 
The structure of the package, 
functions developed, 
and data tables are shown in Figure \@ref(fig:SI_ERD), 
which indicates
how the package takes input from three files: 
a gtfs feed (gtfs.zip); 
a sf object 
describing the geometry 
of the areas of interest 
for which the SI is to be calculated; and 
a csv file 
(included in the package) 
defining the buffer zone distances
for each route type. 
The ultimate output 
is a si_by_area_and_hour table 
(Figure \@ref(fig:SI_ERD), bottom-right), 
which reports the SI score for each hour 
of a day specified by the user. 


```{r SI_ERD, crop = TRUE, fig.cap = "Entity Relationship Diagram (ERD) showing the data structure and functions related to the gtfssupplyindex package", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
knitr::include_graphics("graphics/SI_data_structure.png")

```

The various functions 
included in the package 
and their output 
are explained in the following, 
using the Mornington Peninsula GTFS 
as a worked example^[This paper itself 
was prepared in Rmarkdown and is available at https://github.com/James-Reynolds/gtfssupplyindex_main_paper. 
Code snippets used to produce the outputs 
of the worked example can be viewed there.]
Individual steps are as follows:

(1) The GTFS data is loaded using  
the gtfs_by_route_type function 
which also splits it into a list (by route_type) of tidygtfs objects, 
using the filter_by_route_type function from the gtfstools package [@filter_GTFS_by_mode].

```{r load_mornington_GTFS data, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

```

(2) Geometry information about the areas of interest is loaded by the load_areas_of_interest
function using the sf package [@R-sf]. 
The resultant areas_of_interest table 

(3) The walking distance threshold assigned to each route_type (mode)
is then loaded, using the load_buffer_zone function.

```{r load_ABS data, echo = FALSE, error = FALSE, include = FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}

suppressWarnings({
areas_of_interest <- load_areas_of_interest(areas_of_interest = sf::st_read(system.file(
  "extdata",
  "mornington_sa12021.geojson", 
  package = "gtfssupplyindex", 
  mustWork = TRUE)), 
  area_id_field = "sa1_code_2021")
})

#head(areas_of_interest) %>% kable(caption = "First 6 entries in areas of interest table")
```

```{r load_buffer_distance_data, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
buffer_distance <- gtfssupplyindex:::load_buffer_zones()
#head(buffer_distance) %>% kable(caption = "First six entries in buffer distance definitions")
```

(4) Stops within the catchment walking distance of each area_of_interest are then identified using the stops_in_walk_dist function. Figure \@ref(fig:calculate_stop_in_or_near_areas_verbose) shows how this functions identifies the SA1 areas within the 800 metre catchment of all three of the Mornington stations.


```{r calculate_stop_in_or_near_areas_verbose, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%', fig.keep = "first", crop = TRUE, fig.cap= "Step 3, stop catchments for the Mornington Penninsula Tourist Railway, showing intersections with SA1 zones"}
stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355, 
  verbose = TRUE
)

```

(5) SI scores are calculated for a given time period using the si_calc function, 
which first identifies the 
number of arrivals in a given time period 
at each stop 
using code adapted from an article included in the tidytransit package
[@tidytransit_departure_timetable]. 
The area terms of the SI value are calculated,
with the si_total and hourly functions providing aggregation by area or by area and hour.
Figure \@ref(fig:SI_mornington_20181230_output) shows the hourly output for the Mornington Peninsula Railway, 
adopting December 30, 2018 as the date of analysis. 

```{r arrivals_mornington_20181230, echo = FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}

stop_ids <- list_gtfs[[1]]$stops %>%
 dplyr::select(stop_id)

arrivals_by_stop_id <- gtfssupplyindex::arrivals(
 gtfs = list_gtfs[[1]],
 stop_ids = stop_ids,
 date_ymd = "2018-12-30",
 start_hms = lubridate::hms("10:30:00"),
 end_hms = lubridate::hms("16:00:00")
)

#arrivals_by_stop_id %>% kable(caption = "Arrivals at each stop for Sunday December 30th 2018, Mornington Peninsula tourist railway.")

```
<!--- This matches the number of trips shown in the Mornington Railway GTFS feed, being 4 in each direction^[https://transitfeeds.com/p/mornington-railway/806/latest/stop/1388695887/20181230]. 

```{r SI_Mornington_arrivals, fig.margin = FALSE, crop = TRUE, fig.cap = "Arrivals at Mornington Station (stop id 1388695887) for 30/12/2018", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
knitr::include_graphics("graphics/1388695887_inbound.png")

```

All the inputs to calculate the si are now available. Hence, the SI.calc function can be run, resulting in the si_by_route_type list (by route_type) of tables showing the area_id corresponding SI values

```{r SI_mornington_20181230, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}
####-----first load all the inputs

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

areas_of_interest <- load_areas_of_interest(absmapsdata::sa22021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa2_code_2021),  area_id_field = "sa2_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

####----run SI.calc function to build si_by_mode_and_time list (by route_type) of tables

si_by_route_type <- si_calc(
    list_gtfs = list_gtfs,
    stops_in_or_near_areas = stops_in_or_near_areas, 
    date_ymd = lubridate::ymd("2018-12-30"), 
    start_hms = lubridate::hms("10:30:00"),
    end_hms = lubridate::hms("16:00:00"),
    verbose = TRUE)

si_by_route_type %>% kable(caption = "SI values for Mornington Penninsula Railway services on 30/12/2018 (full day)")

```

The si_total function aggregates the si_by_route_type tables so that values are no longer separated by mode. Although in the case of the Mornington Penninsula Railway there is only one route_type.  

Finally, the hourly function runs the si_calc and si_total functions for every hour in a single day. It outputs a table showing the SI scores for each area for each hour of the day^[Across the service span]. The below table shows this output, together with row and column totals.  

```{r SI_hourly_mornington_20181230, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}

si_by_area_and_hour_wider <- hourly(list_gtfs, stops_in_or_near_areas, "2018-12-30")

si_by_area_and_hour_wider %>% adorn_totals(where = c("row", "col")) %>% kable(caption = "Mornington Penninsula Tourist Railway hourly SI values for December 30, 2018, for SA1 zones")

```
--->

```{r SI_mornington_20181230_output, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, crop = TRUE, fig.cap = "Mornington Penninsula Tourist Railway hourly SI values for December 30, 2018"}
####-----first load all the inputs

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021),  area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour <- hourly(list_gtfs, stops_in_or_near_areas, "2018-12-30")


si_by_area_and_hour_wider <- pivot_wider(si_by_area_and_hour, names_from = hour_starting, values_from = SI)

#si_by_area_and_hour_wider %>% 
#  head() %>%
#  adorn_rounding() %>%
#  kable(caption = "Mornington Peninsula Tourist Railway hourly SI values for December 30, 2018")

map_areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021),  area_id_field = "sa1_code_2021")

#Join SI to map data
map_si_by_area_and_hour <- merge(map_areas_of_interest, si_by_area_and_hour)

map_si_by_area_and_hour <- na.omit(map_si_by_area_and_hour)

ggplot() + 
  geom_sf(data=map_si_by_area_and_hour,
          aes(fill = SI)) +
            facet_wrap(vars(hour_starting)) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  )



```



## SI scores 
### Greater Melbourne 
```{r Greater_Melbourne_2016_2021, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="SI scores, census day 2016 and 2021"}


###2021
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_210810 <- read.csv("results/Greater_Melbourne/si_by_SA12021area_and_hour_210810")
si_by_area_and_hour_210810 <- si_by_area_and_hour_210810[,2:4]
si_by_area_and_hour_210810$area_id <- as.character(si_by_area_and_hour_210810$area_id)


si_by_area_210810 <- si_by_area_and_hour_210810 %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))

si_by_area_210810$Year <- 2021

###2016
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_160809 <- read.csv("results/Greater_Melbourne/si_by_SA12021area_and_hour_160809")
si_by_area_and_hour_160809 <- si_by_area_and_hour_160809[,2:4]
si_by_area_and_hour_160809$area_id <- as.character(si_by_area_and_hour_160809$area_id)

si_by_area_160809 <- si_by_area_and_hour_160809 %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))


si_by_area_160809$Year <- 2016

si_by_area_2016_2021 <- add_row(si_by_area_160809, si_by_area_210810)

names(si_by_area_2016_2021) <- c("sa1_code_2021", "SI", "Year")

si_by_area_2016_2021_wider <- si_by_area_2016_2021 %>% 
  pivot_wider( 
              names_from = "Year", 
              values_from = "SI")

si_by_area_2016_2021_wider <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021, sa3_name_2021) %>%
    st_drop_geometry(),
  si_by_area_2016_2021_wider 
)
  


si_by_area_2016_2021_wider_sa3 <- si_by_area_2016_2021_wider %>% 
  na.omit() %>% 
   group_by(sa3_name_2021) %>%    
           summarize(sum(`2016`), sum(`2021`))

names(si_by_area_2016_2021_wider_sa3) <- c("sa3_name_2021", "2016", "2021")


si_by_area_2016_2021_sa3 <- si_by_area_2016_2021_wider_sa3 %>%
  pivot_longer(
    cols = 2:3, 
    names_to = "Year",
    values_to = "SI"
  )



si_by_area_2016_2021 <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021),
  si_by_area_2016_2021 
)
  


plot_2016_2021_comparison <- ggplot() + 
  geom_sf(data=si_by_area_2016_2021 %>% na.omit(),
          aes(fill = SI), lwd=0) +
  facet_wrap(vars(Year), ncol = 1) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  scale_fill_distiller(palette = "Spectral", trans = "log10", direction = 1)

#Calculate difference
si_by_area_2016_2021_wider <- si_by_area_2016_2021_wider %>% na.omit()
si_by_area_2016_2021_wider$Difference <- si_by_area_2016_2021_wider$`2021` - si_by_area_2016_2021_wider$`2016`

si_by_area_2016_2021_wider$`Percent Difference` <- si_by_area_2016_2021_wider$Difference / si_by_area_2016_2021_wider$`2016`

si_by_area_2016_2021_wider <- si_by_area_2016_2021_wider %>% na.omit()


si_by_area_2016_2021_wider <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021),
  si_by_area_2016_2021_wider 
)
  


plot_2016_2021_difference_increase <- ggplot() + 
  geom_sf(data=(si_by_area_2016_2021_wider %>% na.omit() %>% filter(Difference > 0)),
          aes(fill = Difference), lwd=0) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  scale_fill_distiller(palette = "Greens", trans = "log10", direction = 1)

plot_2016_2021_difference_decrease <- ggplot() + 
  geom_sf(data=(si_by_area_2016_2021_wider %>% na.omit() %>% filter(Difference < 0)),
          aes(fill = -Difference), lwd=0) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  scale_fill_distiller(palette = "Reds", trans = "log10", direction = 1)




plot_2016_2021_percent_difference_less_than_2x <- ggplot() + 
  geom_sf(data=(si_by_area_2016_2021_wider %>% na.omit() %>% filter(`2016` != 0) %>% filter(`Percent Difference` < 2)),
          aes(fill = `Percent Difference`), lwd=0) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  scale_fill_distiller(palette = "Spectral", direction = 1, labels = scales::percent_format())



plot_2016_2021_percent_difference_more_than_2x <- ggplot() + 
  geom_sf(data=(si_by_area_2016_2021_wider %>% na.omit() %>% filter(`2016` != 0) %>% filter(`Percent Difference` >= 2)),
          aes(fill = `Percent Difference`), lwd=0) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  scale_fill_distiller(palette = "Spectral", direction = 1, labels = scales::percent_format())


#plot_2016_2021_comparison 
#plot_2016_2021_difference_increase 
#plot_2016_2021_difference_decrease 
#plot_2016_2021_percent_difference_less_than_2x 
#plot_2016_2021_percent_difference_more_than_2x


cuts <- si_by_area_2016_2021 %>% 
  st_drop_geometry() %>% 
  filter(SI != 0) %>% 
  select(SI) %>% 
  unlist()  %>% 
  as.vector() %>% 
  quantileCut(6)


cuts <- sapply(str_extract_all(cuts, "-?[0-9.]+"), function(x) max(as.numeric(x))) %>%
  unique() %>% 
  as.numeric() %>% 
  sort()
  
 si_by_area_2016_2021$SI_binned <- ifelse(
   si_by_area_2016_2021$SI == 0, NA, ifelse(
     si_by_area_2016_2021$SI < cuts[1], "Very low", ifelse(
       si_by_area_2016_2021$SI < cuts[2], "Low", ifelse(
         si_by_area_2016_2021$SI < cuts[3], "Below median", ifelse(
           si_by_area_2016_2021$SI < cuts[4], "Above median", ifelse(
             si_by_area_2016_2021$SI < cuts[5], "High", ifelse(
               si_by_area_2016_2021$SI >= cuts[5], "Very high", NA)
             )
           )
         )
       )
     )
   ) 

si_by_area_2016_2021$SI_binned <- factor(si_by_area_2016_2021$SI_binned, 
                                         levels = c(
                                           "Zero", 
                                           "Very low", 
                                           "Low", 
                                           "Below median",
                                           "Above median", 
                                           "High", 
                                           "Very high"
                                         ))


plot_2016_2021_comparison <- ggplot()+ 
  geom_sf(data=si_by_area_2016_2021 %>% na.omit(),
          aes(fill = SI_binned), colour=NA) +
  facet_wrap(vars(Year), nrow = 1) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(),
        legend.position="bottom") + #remove y axis ticks
  scale_fill_manual(values = c("#F9D8B1", "#F7C387", "#F29C33", "#5DB000", "#53A212", "#407F0B")) #remove y axis ticks
      
            
plot_2016_2021_comparison

```

Figure \ref{fig:Greater_Melbourne_2016_2021} shows SI values on census day for Greater Melbourne in 2016 and 2021. Comparison to Figure \ref{fig:Currie_map_SI} indicates that:

- The Greater Melbourne Greater Capital City Statistical Area now covers a larger area than it did in 2006, with the northern boundary having shifted northwards by up to around 40 kilometres ^[See https://maps.abs.gov.au/?xmin=15884115.813179802&ymin=-4689558.173698483&xmax=16551869.692279067&ymax=-4397262.977535984&bottomlayer=ASGS2021:GCCSA&toplayer=ASGC2006:SD].
- There are still many areas, typically in the outer parts of Melbourne, where there is very low or zero transit supply. 
- A similar pattern of higher transit supply near railway lines is evident, but there appears to be more areas with above average or better service levels further out from the centre of the city.
- In general, above average, high and very high service levels appear to be more spread out, especially into the middle suburbs. 
- Comparing 2016 and 2021 suggests that the geographic spread of service levels has remained largely the same, albeit with some areas that had little to no transit service appearing to have new services 


```{r Greater_Melbourne_2016_2021, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = TRUE, fig.fullwidth = TRUE, fig.cap="SI scores by SA3, census day 2016 and 2021"}

si_by_area_2016_2021 <- si_by_area_2016_2021 %>%
  st_drop_geometry()

si_by_area_2016_2021 %>% 
  ggwithinstats( 
  x = Year, 
  y = SI,
  ) + 
  scale_y_continuous(trans = "log", breaks = c(1000, 10000, 100000, 1000000))


```

```{r Greater_Melbourne_2016_2021, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = TRUE, fig.fullwidth = TRUE, fig.cap="SI scores by SA3, census day 2016 and 2021"}

si_by_area_2016_2021 <- si_by_area_2016_2021 %>%
  st_drop_geometry()

si_by_area_2016_2021_wider %>% 
  st_drop_geometry() %>%
  na.omit() %>%
  ggscatterstats( 
  x = "2016", 
  y = "2021",
  ) + 
  scale_y_continuous(trans = "log", breaks = c(1000, 10000, 100000, 1000000))


```





```{r Greater_Melbourne_2016_2021_change_in_bin, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="SI scores, change in level between 2016 and 2021"}

si_by_area_2016_2021$SI_binned_numeric <- si_by_area_2016_2021$SI_binned %>%
  fct_recode("Very low" = "1", 
             "Low" = "2", 
             "Below median" = "3", 
             "Above meidan" = "4", 
             "High" = "5", 
             "Very high" = "6") %>%
  as.numeric()



si_by_area_2016_2021 <- si_by_area_2016_2021 %>% mutate(SI_binned_numeric = ifelse(is.na(SI_binned_numeric), 0, SI_binned_numeric))


si_by_area_2016_2021_bins_wider <- si_by_area_2016_2021 %>% 
  select(sa1_code_2021, Year, SI_binned_numeric) %>% 
  pivot_wider(
    names_from = "Year",
    values_from = "SI_binned_numeric"
  )

si_by_area_2016_2021_bins_wider$SI_bin_numeric_change <- 
  si_by_area_2016_2021_bins_wider$`2021` -
  si_by_area_2016_2021_bins_wider$`2016`
  
si_by_area_2016_2021_bins_wider$SI_bin_numeric_change %>%
  tabyl() %>%
  adorn_totals("row") %>%
  adorn_pct_formatting() %>%
    kable(caption = "Change is SI score level, frequency distribution")

  
```


```{r Greater_Melbourne_2016_2021_change_in_bin, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="SI scores, change in level between 2016 and 2021"}

si_by_area_2016_2021_bins_wider <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne"),
  si_by_area_2016_2021_bins_wider)

ggplot()+ 
  geom_sf(data=si_by_area_2016_2021_bins_wider,
          aes(fill = SI_bin_numeric_change), colour=NA) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(),
        legend.position="bottom") +
  scale_fill_distiller(palette = "RdBu", direction = 1)
  
ggplot() + 
  geom_sf(data=(si_by_area_2016_2021_wider),
          aes(fill = Difference), lwd=0) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  scale_fill_distiller(palette = "RdBu", direction = 1)


```




```{r Greater_Melbourne_2016_2021_increases_decreases, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="SI scores, changes between 2016 and 2021, raw scores"}

plot_2016_2021_difference_increase 
plot_2016_2021_difference_decrease 

```



### IMRAD



## Comparing cases


### Population and equality

## Purpose of transit in the city's transport policy

## Indexes and comparing cities


# Discussion

## Limitations 

## Directions for furture research

# Conclusions

# References {-}



```{r, include=FALSE}
knitr::write_bib(file = 'packages.bib')
```

