---
title: "New GTFS tools for benchmarking public tranpsort service levels"
author:
  - name: James Reynolds
    email: james.reynolds@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    correspondingauthor: true
    footnote: 1
  - name: Yanda Qu
    email: yanda.qu@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    footnote: 2
  - name: Graham Currie
    email: graham.currie@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    footnote: 3
address:
  - code: Public Transport Research Group (PTRG)
    organization: Public Transport Research Group (PTRG), Institute of Transport Studies, Department of Civil Engineering Engineering, Monash University
    addressline: Clayton Campus
    city: Melbourne 
    state: Victoria
    postcode: 3800
    country: Australia
  
footnote:
  - code: 1
    text: "Research Fellow"
  - code: 2
    text: "PhD Strudent"
  - code: 3
    text: "Professor"
abstract: |
  This is the abstract.

  It consists of two paragraphs.
keywords: 
  - keyword1
  - keyword2
journal: "Transport Geography?"
date: "`r Sys.Date()`"
classoption: preprint, 3p, authoryear
bibliography: References.bib, packages.bib
linenumbers: false
numbersections: true
# Use a CSL with `citation_package = "default"`
# csl: https://www.zotero.org/styles/elsevier-harvard
output: 
  rticles::elsevier_article:
    keep_tex: true
    citation_package: natbib
    extra_dependencies: "subfig"
---



```{r setup, include=FALSE}
library(tidyverse)
library(tidytransit)
library(sp)
library(strayr)
library(ptinpoly)
library(magrittr)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(janitor)
library(mapview)
library(ggstatsplot)
library(gtsummary)
library(moments)
library(scales)
library(gtfstools)
library(lubridate)
library(kableExtra)
library(knitr)
library(readxl)
library(dplyr)
library(devtools)
library(gtfssupplyindex)
library(readabs)
library(gglorenz)
library(DescTools)
# invalidate cache when the tufte version changes
#knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))

```



# Introduction
There appears to be few tools readily available for benchmarking public transport 
service levels in a manner focused towards a non-technical audience.  Those that 
are available are either:

- closed source, such as Walk Score's Transit Score [@WalkScore:2023tg], such that they cannot be used independently by practitioners, advocates or others; 

- complicated and focused towards practitioners, such as Transit Capacity and Quality of Service Manual 
(TCQSM)[@TCQSM:2013] 700 page guidebook full of indicators, and the extensive annual benchmarking program undertaken yearly by the Transport Strategy Centre in the United Kingdom [@Imperial-College-London:2023aa]; or

- bespoke, having been applied to only a small number (or just one) system, 
such as the assessment of service levels and change in Melbourne by @Currie2016BoldIdeas.


Previous research by @currie2007identifying 
developed a transit Supply Index (SI), 
which has the advantage of providing a single score based 
on the number of transit arrivals 
at stops within an area of interest,   
adjusted to account 
the walking distance catchment of each stop. 
Unfortunately, 
the SI does not appear to have been widely used,
perhaps in part because at the time it was first published 
timetable data was not typically available 
in a standardized 
and machine-readable format.  
Nowadays, 
the General Transit Feed Specification (GTFS) 
allows timetable publication in a standardized format, 
with more than 10,000 agencies 
providing feeds[@GTFS].
Many visualization, processing and analysis tools 
that accept GTFS data are now available.
A gap, however, is that 
there is not yet a tool to calculate SI scores directly from 
GTFS datasets.

This provides the motivation 
for the research reported in this paper, 
in which a new R package (gtfssupplyindex) 
specifically developed to calculate SI scores 
is presented. 
The paper also explores how these SI scores can be used to assess 
transit supply across 
mode, region, level-boarding access, city and apparent policy type.


The remainder of this paper is structured as follows:
the next section outlines the background to this research,
including the original formulation of the Transit Supply Index, 
and an explanation of the GTFS. 
Section 3 then describes the study methodology, 
followed by presentation of results in Section 4. 
Section 5 discusses the results, 
outlines directions for future research 
and provides a brief conclusion. 

# Background

## Transit metrics
Even a brief search reveals 
many metrics 
available for benchmarking transit services. 
Examples include: 
(1) those in the Transit Cooperative Research Program (TCRP) Report 88, 
which is an extensive guidebook 
on developing a performance-measurement system [@Ryus:2003aa]; 
(2) online databases provided by 
the Florida Transit Information System (FTIS) 
[@Florida-Transit-Information-System:2018aa] 
and @UITP:2015aa; 
(3) those used in the extensive annual benchmarking program
undertaken yearly by the Transport Strategy Centre in the United Kingdom, 
including over 100 transit providers around the world [@Imperial-College-London:2023aa]; and
(4) a recently developed methodology to calculate 'blank spots', 
beyond typical walking access distances 
to/from transit stops[@AlamriSultan2023GAoA]. 
  
  
The Fielding Triangle [@FieldingGordonJ1987Mpts] 
provides a framework 
for combining indicators of 
service inputs, 
outputs 
and consumption 
to describe cost efficiency, 
cost effectiveness and
service effectiveness. 
More broadly: 

- @Litman:2003ab 
and @Litman:2016aa 
discuss some of the traffic, 
mobility, 
accessibility, 
social equity, 
strategic planning 
and other rational decision-making-based
perspectives underling transport indicators;

- @Reynolds:2017ah extends 
these into models of how 
institutionalism, 
incrementalism 
and other public policy analysis concepts 
might apply to decision-making processes 
relating to transit prioritization; 

- @GuzmanLuisA.2017Aeit, 
developed a measure of accessibility 
in the context of policy development 
and social equity 
for Latin American Bus Rapid Transit (BRT) networks; and 

- @Creutzig2020streetspaceallocation
introduced street space allocation metrics 
based around 10 ethical principles 

However, 
many of these metrics appear difficult to calculate, 
complex to explain or understand, 
and likely not well suited to communication 
with those who are not planners or engineers, 
or other technical specialists. 
Where pre-calculated metrics 
are immediately available 
it may not be possible for practitioners, 
researchers 
or advocates 
to independently generate metrics 
for proposed system changes. 
Sometimes it is not even possible 
to know precisely how scores for the existing services levels are calculated. 
For example, 
Transit Scores 
for locations with a published GTFS feed 
are readily available on the @WalkScore:2023tg website, 
eliminating the need for any calculations. 
The meaning of these Transit Scores 
appears easy to explain, 
as the highest possible score of 100 
represents what might be experienced in the centre of New York. 
However, 
the Transit Score algorithm 
is patented 
and effectively a black box. 
Transit Scores cannot be calculated independently
or generated 
for proposed changes to networks. 

## GTFS
The General Transit Feed Specification (GTFS)
is an open, 
text-based format 
developed originally to allow transit 
to be included in the Google Maps navigation platform [@GTFS]. 
Figure \@ref(fig:GTFS_ERD) shows 
an Entity Relationship Diagram (ERD) 
of the GTFS data structure. 
This indicates how GTFS data 
is stored as a series of tables 
(agency, routes, trips etc.)
with primary and foreign keys (agency_id, route_id, trip_id etc.) 
providing links.


```{r GTFS_ERD, crop = TRUE, fig.cap = "GTFS entity relationship diagram. Source: adapted by author from Alamri et al (2023) and the GTFS Schedule Reference (16/11/2023 revision).", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
knitr::include_graphics("graphics/GTFS.png")

```

GTFS allows individual transit systems 
to be included in many online products and analysis, 
including the Transit Score metric itself. 
@Wong:2013aa provides another example of what can be done with GTFS data, 
having developed code to calculate of some of the TCQSM metrics 
and compared these
across 50 transit operators.

## The Transit Suppy Index
A generalized form of the Transit Supply Index (SI) from Currie and Senbergs (2007) is: 

  $$SI_{area, time} = \sum{\frac{Area_{Bn}}{Area_{area}}*SL_{n, time}}$$

where:
(1) $SI_{area, time}$ is the Supply Index for the area of interest 
and a given period of time;
(2) $Area_{Bn}$ is the buffer area for each stop (n) within the area of interest. 
In Currie and Senbergs (2007) this was based on 
a radius of 400 metres for bus and tram stops, 
and 800 metres for railway stations;
(3) $Area_{area}$ is the area of the area of interest; and
(4) $SL_{n,time}$ is the number of transit arrivals for each stop 
for a given time period.

The SI score does not incorporate 
service span, 
speed 
or other elements of a transit service. 
While these can be important 
to passenger experience, 
they might add complexity. 
Simplicity is also helped 
by the way 
that the SI is additive, 
in that $SI_{area, time}$ scores can be aggregated 
to calculate an overall score 
across multiple time periods 
or for a region encompassing multiple areas of interest. 


# Methodology
This study 
developed a package 
with tools for calculating the SI from GTFS data. 
The R programming language [@R-base] 
was adopted for code development. 
Package development setup and workflow 
as described by @wickham2023r 
was adopted. 
Various existing packages 
were relied upon including: 
the sf package [@R-sf] for geospatial analysis; 
the tidyverse [@tidyverse2019]; 
gtfstools [@R-gtfstools]; and 
tidytransit [@R-tidytransit]. 
Some code was adapted from 
examples, vignettes and other documentation 
in the tidytransit, gtfstools and other packages.

Two cases where used during the code development and testing, 
such that results might be generated for real GTFS data: 
the Mornington Peninsula Tourist Railway GTFS feed 
and the Public Transport Victoria (PTV) GTFS feed, 
both in Victoria, Australia. 
Both were selected primarily for convenience, 
given that the authors are familiar with 
the typical service patterns and geography.

Figure \@ref(Melbourne_map)) shows the areas of interest 
relevant to the code development and testing, 
and selected railway stations. 
Statistical Area (SA) zones from the Australian Bureau of Statistics [@ABSmaps] 
Areas of interest included Greater Melbourne and its SA3 zones (main), 
SA1 zones in the central part of Melbourne (top-right) 
and SA1 zones within 800 metres of the Mornington Penninsula railway (bottom-right).


```{r Melbourne_map, fig.cap = "Areas of interest",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/all_maps.png")

```
## Mornington Penninsula Tourist Railway

The Morning Peninsula Tourist Railway 
is in the outer south-east of Melbourne, 
running on Sundays and Wednesdays 
between Mornington and Moorooduc, 
with an intermediate stop at Tanti Park 
(see https://transitfeeds.com/p/mornington-railway/806/latest/stops). 
A GTFS feed from 2018 
was selected for the purposes of tests and demonstrating the code and output.
Australian Bureau of Statistics (ABS) data was also used, 
sources via the strayr 
and absmapsdata packages [@r-strayr].
The Mornington Peninsular Statistical Area 3 (SA3) zone 
and the Statistical Area 1 (SA1) zones contained within it 
were adopted as the areas of interest. 

```{r mornington_calc, crop = TRUE, fig.cap = "SA1 zones (red), location of Mornington Tourist Railway Stations (black) and boundary of zones within 800m catchment (blue)", fig.width = 3, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}
### ---------------- get abs data for Mornington Peninsula
#options(timeout = 1000)
#remotes::install_github("wfmackey/absmapsdata")

#get_mornington_sa1 <- function(){
#  mornington_sa12021 <- absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021)
#  sf::st_write(mornington_sa12021, "inst/extdata/mornington_sa12021.geojson", append=FALSE)
#  return(mornington_sa12021)
#}
#get_mornington_sa3 <- function(){
#  mornington_sa32021 <- absmapsdata::sa32021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa3_code_2021)
#  sf::st_write(mornington_sa32021, "inst/extdata/mornington_sa32021.geojson", append=FALSE)
#  return(mornington_sa32021)
#}

### ---------------- load SA3 abs maps data for just mornington peninsula
areas_of_interest <- load_areas_of_interest(areas_of_interest = absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021), 
  area_id_field = "sa1_code_2021")

# map the areas_of_interest
map <- areas_of_interest %>% 
  ggplot() +
  geom_sf(aes(geometry = geometry))
#map
#set the EPSG to transform from lat/lon to metres
EPSG_for_transform = 28355

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))
stops_as_sf_mornington <-  list_gtfs[[1]]$stops %>% 
  tidytransit::stops_as_sf()

#map the stops on the ABS data
#map + 
#  geom_sf(data = stops_as_sf_mornington, aes(geometry = geometry))


stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355
)

```

## Public Transport Victoria (PTV)
Larger scale testing was performed using the Victorian GTFS feed, 
published by Public Transport Victoria (PTV) and 
sourced via @transitfeeds_victoria:2023aa for historical feeds. 

```{r fix_ptv_data_Victoria_230804, eval = TRUE, echo = FALSE}


ptv_230804 <- tidytransit::read_gtfs("data/ptv_230804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_230804_duplicated_stops <- tabyl(ptv_230804$stops$stop_id) %>% filter (n>1)
names(ptv_230804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_230804_duplicated_stops <- left_join(ptv_230804_duplicated_stops, ptv_230804$stops)

##discard duplicates
ptv_230804$stops <- ptv_230804$stops[!duplicated(ptv_230804$stops$stop_id),]

## Write gtfs back to file
ptv_230804 <- as_tidygtfs(ptv_230804)
tidytransit::write_gtfs(ptv_230804, "data/ptv_230804/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_all_of_Victoria_230808, eval = TRUE, echo = FALSE}



## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_230808 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808, "results/Victoria/si_by_SA12021area_and_hour_230808")

si_by_area_and_hour_230808_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_tram, "results/Victoria/si_by_SA12021area_and_hour_230808_tram")

si_by_area_and_hour_230808_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_rail, "results/Victoria/si_by_SA12021area_and_hour_230808_rail")

si_by_area_and_hour_230808_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_bus, "results/Victoria/si_by_SA12021area_and_hour_230808_bus")

```



```{r fix_ptv_data_Victoria_220804, eval = TRUE, echo = FALSE}


ptv_220804 <- tidytransit::read_gtfs("data/ptv_220804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_220804_duplicated_stops <- tabyl(ptv_220804$stops$stop_id) %>% filter (n>1)
names(ptv_220804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_220804_duplicated_stops <- left_join(ptv_220804_duplicated_stops, ptv_220804$stops)

##discard duplicates
ptv_220804$stops <- ptv_220804$stops[!duplicated(ptv_220804$stops$stop_id),]

## Write gtfs back to file
ptv_220804 <- as_tidygtfs(ptv_220804)
tidytransit::write_gtfs(ptv_220804, "data/ptv_220804/gtfs_duplicate_stops_removed.zip")

```

```{r run_for_all_modes_Victoria_200809, eval = TRUE, echo = FALSE}

## convert to list of tidygtfs objects
ptv_220804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_220804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_220804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_200809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2022-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200809, "results/Victoria/si_by_SA12021area_and_hour_200809")

si_by_area_and_hour_200809_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2022-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200809_tram, "results/Victoria/si_by_SA12021area_and_hour_200809_tram")

si_by_area_and_hour_200809_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2022-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200809_rail, "results/Victoria/si_by_SA12021area_and_hour_200809_rail")

si_by_area_and_hour_200809_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2022-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200809_bus, "results/Victoria/si_by_SA12021area_and_hour_200809_bus")

```

```{r fix_ptv_data_Victoria_210805, eval = TRUE, echo = FALSE}


ptv_210805 <- tidytransit::read_gtfs("data/ptv_210805/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_210805_duplicated_stops <- tabyl(ptv_210805$stops$stop_id) %>% filter (n>1)
names(ptv_210805_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_210805_duplicated_stops <- left_join(ptv_210805_duplicated_stops, ptv_210805$stops)

##discard duplicates
ptv_210805$stops <- ptv_210805$stops[!duplicated(ptv_210805$stops$stop_id),]

## Write gtfs back to file
ptv_210805 <- as_tidygtfs(ptv_210805)
tidytransit::write_gtfs(ptv_210805, "data/ptv_210805/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_210810, eval = TRUE, echo = FALSE}
list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/Victoria/si_by_SA12021area_and_hour_210810")

si_by_area_and_hour_210810_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_tram, "results/Victoria/si_by_SA12021area_and_hour_210810_tram")

si_by_area_and_hour_210810_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_rail, "results/Victoria/si_by_SA12021area_and_hour_210810_rail")

si_by_area_and_hour_210810_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_bus, "results/Victoria/si_by_SA12021area_and_hour_210810_bus")

```

```{r fix_ptv_data_Victoria_200729, eval = TRUE, echo = FALSE}


ptv_200729 <- tidytransit::read_gtfs("data/ptv_200729/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_200729_duplicated_stops <- tabyl(ptv_200729$stops$stop_id) %>% filter (n>1)
names(ptv_200729_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_200729_duplicated_stops <- left_join(ptv_200729_duplicated_stops, ptv_200729$stops)

##discard duplicates
ptv_200729$stops <- ptv_200729$stops[!duplicated(ptv_200729$stops$stop_id),]

## Write gtfs back to file
ptv_200729 <- as_tidygtfs(ptv_200729)
tidytransit::write_gtfs(ptv_200729, "data/ptv_200729/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_200729_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_200729/gtfs_duplicate_stops_removed.zip")

```

```{r run_for_all_modes_Victoria_200811, eval = TRUE, echo = FALSE}

list_gtfs = ptv_200729_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_200811 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811, "results/Victoria/si_by_SA12021area_and_hour_200811")

si_by_area_and_hour_200811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_tram, "results/Victoria/si_by_SA12021area_and_hour_200811_tram")

si_by_area_and_hour_200811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_rail, "results/Victoria/si_by_SA12021area_and_hour_200811_rail")

si_by_area_and_hour_200811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_bus, "results/Victoria/si_by_SA12021area_and_hour_200811_bus")

```

```{r fix_ptv_data_Victoria_190802, eval = TRUE, echo = FALSE}
ptv_190802 <- tidytransit::read_gtfs("data/ptv_190802/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_190802_duplicated_stops <- tabyl(ptv_190802$stops$stop_id) %>% filter (n>1)
names(ptv_190802_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_190802_duplicated_stops <- left_join(ptv_190802_duplicated_stops, ptv_190802$stops)

##discard duplicates
ptv_190802$stops <- ptv_190802$stops[!duplicated(ptv_190802$stops$stop_id),]

## Write gtfs back to file
ptv_190802 <- as_tidygtfs(ptv_190802)
tidytransit::write_gtfs(ptv_190802, "data/ptv_190802/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_190802_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_190802/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_190813, eval = TRUE, echo = FALSE}

list_gtfs = ptv_190802_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_190813 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813, "results/Victoria/si_by_SA12021area_and_hour_190813")

si_by_area_and_hour_190813_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_tram, "results/Victoria/si_by_SA12021area_and_hour_190813_tram")

si_by_area_and_hour_190813_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_rail, "results/Victoria/si_by_SA12021area_and_hour_190813_rail")

si_by_area_and_hour_190813_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_bus, "results/Victoria/si_by_SA12021area_and_hour_190813_bus")

```

```{r fix_ptv_data_Victoria_180803, eval = TRUE, echo = FALSE}


ptv_180803 <- tidytransit::read_gtfs("data/ptv_180803/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_180803_duplicated_stops <- tabyl(ptv_180803$stops$stop_id) %>% filter (n>1)
names(ptv_180803_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_180803_duplicated_stops <- left_join(ptv_180803_duplicated_stops, ptv_180803$stops)

##discard duplicates
ptv_180803$stops <- ptv_180803$stops[!duplicated(ptv_180803$stops$stop_id),]

## Write gtfs back to file
ptv_180803 <- as_tidygtfs(ptv_180803)
tidytransit::write_gtfs(ptv_180803, "data/ptv_180803/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_180803_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_180803/gtfs_duplicate_stops_removed.zip")


```


```{r run_for_all_modes_Victoria_180814, eval = TRUE, echo = FALSE}


list_gtfs = ptv_180803_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)
si_by_area_and_hour_180814 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814, "results/Victoria/si_by_SA12021area_and_hour_180814")

si_by_area_and_hour_180814_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_tram, "results/Victoria/si_by_SA12021area_and_hour_180814_tram")

si_by_area_and_hour_180814_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_rail, "results/Victoria/si_by_SA12021area_and_hour_180814_rail")

si_by_area_and_hour_180814_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_bus, "results/Victoria/si_by_SA12021area_and_hour_180814_bus")

```

```{r fix_ptv_data_Victoria_170804, eval = TRUE, echo = FALSE}


ptv_170804 <- tidytransit::read_gtfs("data/ptv_170804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_170804_duplicated_stops <- tabyl(ptv_170804$stops$stop_id) %>% filter (n>1)
names(ptv_170804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_170804_duplicated_stops <- left_join(ptv_170804_duplicated_stops, ptv_170804$stops)

##discard duplicates
ptv_170804$stops <- ptv_170804$stops[!duplicated(ptv_170804$stops$stop_id),]

## Write gtfs back to file
ptv_170804 <- as_tidygtfs(ptv_170804)
tidytransit::write_gtfs(ptv_170804, "data/ptv_170804/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_170804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_170804/gtfs_duplicate_stops_removed.zip")

```


```{r run_for_all_modes_Victoria_170808, eval = TRUE, echo = FALSE}


list_gtfs = ptv_170804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_170808 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808, "results/Victoria/si_by_SA12021area_and_hour_170808")

si_by_area_and_hour_170808_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_tram, "results/Victoria/si_by_SA12021area_and_hour_170808_tram")

si_by_area_and_hour_170808_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_rail, "results/Victoria/si_by_SA12021area_and_hour_170808_rail")

si_by_area_and_hour_170808_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_bus, "results/Victoria/si_by_SA12021area_and_hour_170808_bus")

```

```{r fix_ptv_data_Victoria_160804, eval = TRUE, echo = FALSE}
 

ptv_160804 <- tidytransit::read_gtfs("data/ptv_160804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_160804_duplicated_stops <- tabyl(ptv_160804$stops$stop_id) %>% filter (n>1)
names(ptv_160804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_160804_duplicated_stops <- left_join(ptv_160804_duplicated_stops, ptv_160804$stops)

##discard duplicates
ptv_160804$stops <- ptv_160804$stops[!duplicated(ptv_160804$stops$stop_id),]

## Write gtfs back to file
ptv_160804 <- as_tidygtfs(ptv_160804)
tidytransit::write_gtfs(ptv_160804, "data/ptv_160804/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

```

```{r run_for_all_modes_Victoria_160809, eval = TRUE, echo = FALSE}
list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/Victoria/si_by_SA12021area_and_hour_160809")

si_by_area_and_hour_160809_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_tram, "results/Victoria/si_by_SA12021area_and_hour_160809_tram")

si_by_area_and_hour_160809_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_rail, "results/Victoria/si_by_SA12021area_and_hour_160809_rail")

si_by_area_and_hour_160809_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_bus, "results/Victoria/si_by_SA12021area_and_hour_160809_bus")

```

```{r fix_ptv_data_Victoria_150729, eval = TRUE, echo = FALSE}


ptv_150729 <- tidytransit::read_gtfs("data/ptv_150729/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_150729_duplicated_stops <- tabyl(ptv_150729$stops$stop_id) %>% filter (n>1)
names(ptv_150729_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_150729_duplicated_stops <- left_join(ptv_150729_duplicated_stops, ptv_150729$stops)

##discard duplicates
ptv_150729$stops <- ptv_150729$stops[!duplicated(ptv_150729$stops$stop_id),]

## Write gtfs back to file
ptv_150729 <- as_tidygtfs(ptv_150729)
tidytransit::write_gtfs(ptv_150729, "data/ptv_150729/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_150729_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_150729/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_150811, eval = TRUE, echo = FALSE}

list_gtfs = ptv_150729_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_150811 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811, "results/Victoria/si_by_SA12021area_and_hour_150811")

si_by_area_and_hour_150811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_tram, "results/Victoria/si_by_SA12021area_and_hour_150811_tram")

si_by_area_and_hour_150811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_rail, "results/Victoria/si_by_SA12021area_and_hour_150811_rail")

si_by_area_and_hour_150811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_bus, "results/Victoria/si_by_SA12021area_and_hour_150811_bus")

```


# Results
## Code structure and functionality


Developed code is available and documented on github [@gtfssupplyindex_github]. 
The structure of the package, 
functions developed, 
and data tables are shown in Figure \@ref(fig:SI_ERD). 
This shows  
how the package takes input from three files: 
a gtfs feed (gtfs.zip); 
a sf object describing the geometry of the areas 
for which the SI is to be calculated; and 
a csv file (included in the package) 
defining the buffer zone distances
for each route type. The ultimate output 
is a si_by_area_and_hour table (bottom-right), 
which reports the SI score for each hour of the day 
across dates specified by the user. 


```{r SI_ERD, crop = TRUE, fig.cap = "Entity Relationship Diagram (ERD) showing the data structure and functions related to the gtfssupplyindex package", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
knitr::include_graphics("graphics/SI_data_structure.png")

```

Various functions and their output 
are explained in the following, 
using the Mornington Peninsula GTFS for December 30th, 2018, 
and SA1 zone boundaries as a worked example. 
Individual steps are:

(1) loading the gtfs.zip file: 
the gtfs_by_route_type function loads the gtfs data 
and splits it into a list (by route_type) of tidygtfs objects, 
using the filter_by_route_type function from the gtfstools package [@filter_GTFS_by_mode].

```{r load_mornington_GTFS data, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

```

(2) loading geometry information about the areas of interest: 
geographical data about the areas of interest are loaded 
by the load_areas_of_interest.R function into an sf object, 
using the sf package [@R-sf]. 
The resultant areas_of_interest table 
contains each area_id and its associated geometry. 
Data about buffer zones, 
specifically the walking distance threshold assigned to each route_type (mode)
is then loaded, 
again through a function (load_buffer_zone.R).

```{r load_ABS data, echo = FALSE, error = FALSE, include = FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}

suppressWarnings({
areas_of_interest <- load_areas_of_interest(areas_of_interest = sf::st_read(system.file(
  "extdata",
  "mornington_sa12021.geojson", 
  package = "gtfssupplyindex", 
  mustWork = TRUE)), 
  area_id_field = "sa1_code_2021")
})

#head(areas_of_interest) %>% kable(caption = "First 6 entries in areas of interest table")
```

```{r load_buffer_distance_data, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
buffer_distance <- gtfssupplyindex:::load_buffer_zones()
#head(buffer_distance) %>% kable(caption = "First six entries in buffer distance definitions")
```

(3) calculating which stops are within the catchment walking distance of which areas: 
using the stops_in_walk_dist function. Figure \@ref(fig:calculate_stop_in_or_near_areas_verbose)) shows how this function identified
SA1 areas within the 800 metre catchment of the three Mornington stations.


```{r calculate_stop_in_or_near_areas_verbose, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%', fig.keep = "first", crop = TRUE, fig.cap= "Step 3, stop catchments for the Mornington Penninsula Tourist Railway, showing intersections with SA1 zones"}
stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355, 
  verbose = TRUE
)

```

```{r calculate_stop_in_or_near_areas, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355, 
  verbose = FALSE
)

#head(stops_in_or_near_areas[[1]]) %>% kable(caption = "'Rail' element of the stops in or near areas list for the Mornington Pennisula datasets, first six entries")
```


(4) Calculating SI scores for a given time period: 
The si_calc.R function calculates the number of arrivals in a given time period, 
using code adapted from an article included in the tidytransit package
[@tidytransit_departure_timetable],
and combines this with the calculated area components. 
The si_total.R and hourly.R functions provided aggregation, 
giving the results mapped in Figure \@ref(fig:SI_mornington_20181230_output). 

```{r arrivals_mornington_20181230, echo = FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}

stop_ids <- list_gtfs[[1]]$stops %>%
 dplyr::select(stop_id)

arrivals_by_stop_id <- gtfssupplyindex::arrivals(
 gtfs = list_gtfs[[1]],
 stop_ids = stop_ids,
 date_ymd = "2018-12-30",
 start_hms = lubridate::hms("10:30:00"),
 end_hms = lubridate::hms("16:00:00")
)

#arrivals_by_stop_id %>% kable(caption = "Arrivals at each stop for Sunday December 30th 2018, Mornington Peninsula tourist railway.")

```
<!--- This matches the number of trips shown in the Mornington Railway GTFS feed, being 4 in each direction^[https://transitfeeds.com/p/mornington-railway/806/latest/stop/1388695887/20181230]. 

```{r SI_Mornington_arrivals, fig.margin = FALSE, crop = TRUE, fig.cap = "Arrivals at Mornington Station (stop id 1388695887) for 30/12/2018", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
knitr::include_graphics("graphics/1388695887_inbound.png")

```

All the inputs to calculate the si are now available. Hence, the SI.calc function can be run, resulting in the si_by_route_type list (by route_type) of tables showing the area_id corresponding SI values

```{r SI_mornington_20181230, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}
####-----first load all the inputs

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

areas_of_interest <- load_areas_of_interest(absmapsdata::sa22021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa2_code_2021),  area_id_field = "sa2_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

####----run SI.calc function to build si_by_mode_and_time list (by route_type) of tables

si_by_route_type <- si_calc(
    list_gtfs = list_gtfs,
    stops_in_or_near_areas = stops_in_or_near_areas, 
    date_ymd = lubridate::ymd("2018-12-30"), 
    start_hms = lubridate::hms("10:30:00"),
    end_hms = lubridate::hms("16:00:00"),
    verbose = TRUE)

si_by_route_type %>% kable(caption = "SI values for Mornington Penninsula Railway services on 30/12/2018 (full day)")

```

The si_total function aggregates the si_by_route_type tables so that values are no longer separated by mode. Although in the case of the Mornington Penninsula Railway there is only one route_type.  

Finally, the hourly function runs the si_calc and si_total functions for every hour in a single day. It outputs a table showing the SI scores for each area for each hour of the day^[Across the service span]. The below table shows this output, together with row and column totals.  

```{r SI_hourly_mornington_20181230, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}

si_by_area_and_hour_wider <- hourly(list_gtfs, stops_in_or_near_areas, "2018-12-30")

si_by_area_and_hour_wider %>% adorn_totals(where = c("row", "col")) %>% kable(caption = "Mornington Penninsula Tourist Railway hourly SI values for December 30, 2018, for SA1 zones")

```
--->

```{r SI_mornington_20181230_output, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, crop = TRUE, fig.cap = "Mornington Penninsula Tourist Railway hourly SI values for December 30, 2018"}
####-----first load all the inputs

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021),  area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour <- hourly(list_gtfs, stops_in_or_near_areas, "2018-12-30")


si_by_area_and_hour_wider <- pivot_wider(si_by_area_and_hour, names_from = hour_starting, values_from = SI)

#si_by_area_and_hour_wider %>% 
#  head() %>%
#  adorn_rounding() %>%
#  kable(caption = "Mornington Peninsula Tourist Railway hourly SI values for December 30, 2018")

map_areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021),  area_id_field = "sa1_code_2021")

#Join SI to map data
map_si_by_area_and_hour <- merge(map_areas_of_interest, si_by_area_and_hour)

map_si_by_area_and_hour <- na.omit(map_si_by_area_and_hour)

ggplot() + 
  geom_sf(data=map_si_by_area_and_hour,
          aes(fill = SI)) +
            facet_wrap(vars(hour_starting)) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  )



```



## Comparing years



```{r Victoria_yearly, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="Victorian GTFS and central Melbourne SA1 zones, SI values second Tuesday in August, 2015-2022, by mode"}


###Load results from CSV (Precalculated above) and make first column character

si_by_area_and_hour_230808_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_230808_tram")
si_by_area_and_hour_230808_tram <- si_by_area_and_hour_230808_tram[,2:4]
si_by_area_and_hour_230808_tram$area_id <- as.character(si_by_area_and_hour_230808_tram$area_id)

si_by_area_and_hour_230808_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_230808_rail")
si_by_area_and_hour_230808_rail <- si_by_area_and_hour_230808_rail[,2:4]
si_by_area_and_hour_230808_rail$area_id <- as.character(si_by_area_and_hour_230808_rail$area_id)

si_by_area_and_hour_230808_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_230808_bus")
si_by_area_and_hour_230808_bus <- si_by_area_and_hour_230808_bus[,2:4]
si_by_area_and_hour_230808_bus$area_id <- as.character(si_by_area_and_hour_230808_bus$area_id)

### merge dataframes
si_by_area_and_hour_230808_tram$mode <- "Tram"
si_by_area_and_hour_230808_rail$mode <- "Rail"
si_by_area_and_hour_230808_bus$mode <- "Bus"

si_by_area_and_hour_230808_all_modes <- merge(si_by_area_and_hour_230808_tram, si_by_area_and_hour_230808_rail, all = TRUE)
si_by_area_and_hour_230808_all_modes <- merge(si_by_area_and_hour_230808_all_modes, si_by_area_and_hour_230808_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_230808_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_230808_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_230808_all_modes$hour_starting <- hm(map_si_by_area_and_hour_230808_all_modes$hour_starting)
map_si_by_area_and_hour_230808_all_modes$hour_starting <- hour(map_si_by_area_and_hour_230808_all_modes$hour_starting)


###2020
si_by_area_and_hour_220809_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_220809_tram")
si_by_area_and_hour_220809_tram <- si_by_area_and_hour_220809_tram[,2:4]
si_by_area_and_hour_220809_tram$area_id <- as.character(si_by_area_and_hour_220809_tram$area_id)

si_by_area_and_hour_220809_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_220809_rail")
si_by_area_and_hour_220809_rail <- si_by_area_and_hour_220809_rail[,2:4]
si_by_area_and_hour_220809_rail$area_id <- as.character(si_by_area_and_hour_220809_rail$area_id)

si_by_area_and_hour_220809_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_220809_bus")
si_by_area_and_hour_220809_bus <- si_by_area_and_hour_220809_bus[,2:4]
si_by_area_and_hour_220809_bus$area_id <- as.character(si_by_area_and_hour_220809_bus$area_id)

### merge dataframes
si_by_area_and_hour_220809_tram$mode <- "Tram"
si_by_area_and_hour_220809_rail$mode <- "Rail"
si_by_area_and_hour_220809_bus$mode <- "Bus"

si_by_area_and_hour_220809_all_modes <- merge(si_by_area_and_hour_220809_tram, si_by_area_and_hour_220809_rail, all = TRUE)
si_by_area_and_hour_220809_all_modes <- merge(si_by_area_and_hour_220809_all_modes, si_by_area_and_hour_220809_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_220809_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_220809_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_220809_all_modes$hour_starting <- hm(map_si_by_area_and_hour_220809_all_modes$hour_starting)
map_si_by_area_and_hour_220809_all_modes$hour_starting <- hour(map_si_by_area_and_hour_220809_all_modes$hour_starting)



###2021
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_210810_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_210810_tram")
si_by_area_and_hour_210810_tram <- si_by_area_and_hour_210810_tram[,2:4]
si_by_area_and_hour_210810_tram$area_id <- as.character(si_by_area_and_hour_210810_tram$area_id)

si_by_area_and_hour_210810_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_210810_rail")
si_by_area_and_hour_210810_rail <- si_by_area_and_hour_210810_rail[,2:4]
si_by_area_and_hour_210810_rail$area_id <- as.character(si_by_area_and_hour_210810_rail$area_id)

si_by_area_and_hour_210810_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_210810_bus")
si_by_area_and_hour_210810_bus <- si_by_area_and_hour_210810_bus[,2:4]
si_by_area_and_hour_210810_bus$area_id <- as.character(si_by_area_and_hour_210810_bus$area_id)

### merge dataframes
si_by_area_and_hour_210810_tram$mode <- "Tram"
si_by_area_and_hour_210810_rail$mode <- "Rail"
si_by_area_and_hour_210810_bus$mode <- "Bus"

si_by_area_and_hour_210810_all_modes <- merge(si_by_area_and_hour_210810_tram, si_by_area_and_hour_210810_rail, all = TRUE)
si_by_area_and_hour_210810_all_modes <- merge(si_by_area_and_hour_210810_all_modes, si_by_area_and_hour_210810_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_210810_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_210810_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_210810_all_modes$hour_starting <- hm(map_si_by_area_and_hour_210810_all_modes$hour_starting)
map_si_by_area_and_hour_210810_all_modes$hour_starting <- hour(map_si_by_area_and_hour_210810_all_modes$hour_starting)


#########Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_200811_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_200811_tram")
si_by_area_and_hour_200811_tram <- si_by_area_and_hour_200811_tram[,2:4]
si_by_area_and_hour_200811_tram$area_id <- as.character(si_by_area_and_hour_200811_tram$area_id)

si_by_area_and_hour_200811_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_200811_rail")
si_by_area_and_hour_200811_rail <- si_by_area_and_hour_200811_rail[,2:4]
si_by_area_and_hour_200811_rail$area_id <- as.character(si_by_area_and_hour_200811_rail$area_id)

si_by_area_and_hour_200811_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_200811_bus")
si_by_area_and_hour_200811_bus <- si_by_area_and_hour_200811_bus[,2:4]
si_by_area_and_hour_200811_bus$area_id <- as.character(si_by_area_and_hour_200811_bus$area_id)

### merge dataframes
si_by_area_and_hour_200811_tram$mode <- "Tram"
si_by_area_and_hour_200811_rail$mode <- "Rail"
si_by_area_and_hour_200811_bus$mode <- "Bus"

si_by_area_and_hour_200811_all_modes <- merge(si_by_area_and_hour_200811_tram, si_by_area_and_hour_200811_rail, all = TRUE)
si_by_area_and_hour_200811_all_modes <- merge(si_by_area_and_hour_200811_all_modes, si_by_area_and_hour_200811_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_200811_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_200811_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_200811_all_modes$hour_starting <- hm(map_si_by_area_and_hour_200811_all_modes$hour_starting)
map_si_by_area_and_hour_200811_all_modes$hour_starting <- hour(map_si_by_area_and_hour_200811_all_modes$hour_starting)

#####
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_190813_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_190813_tram")
si_by_area_and_hour_190813_tram <- si_by_area_and_hour_190813_tram[,2:4]
si_by_area_and_hour_190813_tram$area_id <- as.character(si_by_area_and_hour_190813_tram$area_id)

si_by_area_and_hour_190813_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_190813_rail")
si_by_area_and_hour_190813_rail <- si_by_area_and_hour_190813_rail[,2:4]
si_by_area_and_hour_190813_rail$area_id <- as.character(si_by_area_and_hour_190813_rail$area_id)

si_by_area_and_hour_190813_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_190813_bus")
si_by_area_and_hour_190813_bus <- si_by_area_and_hour_190813_bus[,2:4]
si_by_area_and_hour_190813_bus$area_id <- as.character(si_by_area_and_hour_190813_bus$area_id)

### merge dataframes
si_by_area_and_hour_190813_tram$mode <- "Tram"
si_by_area_and_hour_190813_rail$mode <- "Rail"
si_by_area_and_hour_190813_bus$mode <- "Bus"

si_by_area_and_hour_190813_all_modes <- merge(si_by_area_and_hour_190813_tram, si_by_area_and_hour_190813_rail, all = TRUE)
si_by_area_and_hour_190813_all_modes <- merge(si_by_area_and_hour_190813_all_modes, si_by_area_and_hour_190813_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_190813_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_190813_all_modes)


#####
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_180814_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_180814_tram")
si_by_area_and_hour_180814_tram <- si_by_area_and_hour_180814_tram[,2:4]
si_by_area_and_hour_180814_tram$area_id <- as.character(si_by_area_and_hour_180814_tram$area_id)

si_by_area_and_hour_180814_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_180814_rail")
si_by_area_and_hour_180814_rail <- si_by_area_and_hour_180814_rail[,2:4]
si_by_area_and_hour_180814_rail$area_id <- as.character(si_by_area_and_hour_180814_rail$area_id)

si_by_area_and_hour_180814_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_180814_bus")
si_by_area_and_hour_180814_bus <- si_by_area_and_hour_180814_bus[,2:4]
si_by_area_and_hour_180814_bus$area_id <- as.character(si_by_area_and_hour_180814_bus$area_id)

### merge dataframes
si_by_area_and_hour_180814_tram$mode <- "Tram"
si_by_area_and_hour_180814_rail$mode <- "Rail"
si_by_area_and_hour_180814_bus$mode <- "Bus"

si_by_area_and_hour_180814_all_modes <- merge(si_by_area_and_hour_180814_tram, si_by_area_and_hour_180814_rail, all = TRUE)
si_by_area_and_hour_180814_all_modes <- merge(si_by_area_and_hour_180814_all_modes, si_by_area_and_hour_180814_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_180814_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_180814_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_180814_all_modes$hour_starting <- hm(map_si_by_area_and_hour_180814_all_modes$hour_starting)
map_si_by_area_and_hour_180814_all_modes$hour_starting <- hour(map_si_by_area_and_hour_180814_all_modes$hour_starting)

#####
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_170808_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_170808_tram")
si_by_area_and_hour_170808_tram <- si_by_area_and_hour_170808_tram[,2:4]
si_by_area_and_hour_170808_tram$area_id <- as.character(si_by_area_and_hour_170808_tram$area_id)

si_by_area_and_hour_170808_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_170808_rail")
si_by_area_and_hour_170808_rail <- si_by_area_and_hour_170808_rail[,2:4]
si_by_area_and_hour_170808_rail$area_id <- as.character(si_by_area_and_hour_170808_rail$area_id)

si_by_area_and_hour_170808_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_170808_bus")
si_by_area_and_hour_170808_bus <- si_by_area_and_hour_170808_bus[,2:4]
si_by_area_and_hour_170808_bus$area_id <- as.character(si_by_area_and_hour_170808_bus$area_id)

### merge dataframes
si_by_area_and_hour_170808_tram$mode <- "Tram"
si_by_area_and_hour_170808_rail$mode <- "Rail"
si_by_area_and_hour_170808_bus$mode <- "Bus"

si_by_area_and_hour_170808_all_modes <- merge(si_by_area_and_hour_170808_tram, si_by_area_and_hour_170808_rail, all = TRUE)
si_by_area_and_hour_170808_all_modes <- merge(si_by_area_and_hour_170808_all_modes, si_by_area_and_hour_170808_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_170808_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_170808_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_170808_all_modes$hour_starting <- hm(map_si_by_area_and_hour_170808_all_modes$hour_starting)
map_si_by_area_and_hour_170808_all_modes$hour_starting <- hour(map_si_by_area_and_hour_170808_all_modes$hour_starting)

#####
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_160809_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_160809_tram")
si_by_area_and_hour_160809_tram <- si_by_area_and_hour_160809_tram[,2:4]
si_by_area_and_hour_160809_tram$area_id <- as.character(si_by_area_and_hour_160809_tram$area_id)

si_by_area_and_hour_160809_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_160809_rail")
si_by_area_and_hour_160809_rail <- si_by_area_and_hour_160809_rail[,2:4]
si_by_area_and_hour_160809_rail$area_id <- as.character(si_by_area_and_hour_160809_rail$area_id)

si_by_area_and_hour_160809_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_160809_bus")
si_by_area_and_hour_160809_bus <- si_by_area_and_hour_160809_bus[,2:4]
si_by_area_and_hour_160809_bus$area_id <- as.character(si_by_area_and_hour_160809_bus$area_id)

### merge dataframes
si_by_area_and_hour_160809_tram$mode <- "Tram"
si_by_area_and_hour_160809_rail$mode <- "Rail"
si_by_area_and_hour_160809_bus$mode <- "Bus"

si_by_area_and_hour_160809_all_modes <- merge(si_by_area_and_hour_160809_tram, si_by_area_and_hour_160809_rail, all = TRUE)
si_by_area_and_hour_160809_all_modes <- merge(si_by_area_and_hour_160809_all_modes, si_by_area_and_hour_160809_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_160809_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_160809_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_160809_all_modes$hour_starting <- hm(map_si_by_area_and_hour_160809_all_modes$hour_starting)
map_si_by_area_and_hour_160809_all_modes$hour_starting <- hour(map_si_by_area_and_hour_160809_all_modes$hour_starting)


#####
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_150811_tram <- read.csv("results/Victoria/si_by_SA12021area_and_hour_150811_tram")
si_by_area_and_hour_150811_tram <- si_by_area_and_hour_150811_tram[,2:4]
si_by_area_and_hour_150811_tram$area_id <- as.character(si_by_area_and_hour_150811_tram$area_id)

si_by_area_and_hour_150811_rail <- read.csv("results/Victoria/si_by_SA12021area_and_hour_150811_rail")
si_by_area_and_hour_150811_rail <- si_by_area_and_hour_150811_rail[,2:4]
si_by_area_and_hour_150811_rail$area_id <- as.character(si_by_area_and_hour_150811_rail$area_id)

si_by_area_and_hour_150811_bus <- read.csv("results/Victoria/si_by_SA12021area_and_hour_150811_bus")
si_by_area_and_hour_150811_bus <- si_by_area_and_hour_150811_bus[,2:4]
si_by_area_and_hour_150811_bus$area_id <- as.character(si_by_area_and_hour_150811_bus$area_id)

### merge dataframes
si_by_area_and_hour_150811_tram$mode <- "Tram"
si_by_area_and_hour_150811_rail$mode <- "Rail"
si_by_area_and_hour_150811_bus$mode <- "Bus"

si_by_area_and_hour_150811_all_modes <- merge(si_by_area_and_hour_150811_tram, si_by_area_and_hour_150811_rail, all = TRUE)
si_by_area_and_hour_150811_all_modes <- merge(si_by_area_and_hour_150811_all_modes, si_by_area_and_hour_150811_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_150811_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_150811_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_150811_all_modes$hour_starting <- hm(map_si_by_area_and_hour_150811_all_modes$hour_starting)
map_si_by_area_and_hour_150811_all_modes$hour_starting <- hour(map_si_by_area_and_hour_150811_all_modes$hour_starting)

names(si_by_area_and_hour_150811_all_modes) <- 
  c("area_id", "2015", "hour_starting", "mode")
names(si_by_area_and_hour_160809_all_modes) <- 
  c("area_id", "2016", "hour_starting", "mode")
names(si_by_area_and_hour_170808_all_modes) <- 
 c("area_id", "2017", "hour_starting", "mode")
names(si_by_area_and_hour_180814_all_modes) <- 
  c("area_id", "2018", "hour_starting", "mode")
names(si_by_area_and_hour_190813_all_modes) <- 
  c("area_id", "2019", "hour_starting", "mode")
names(si_by_area_and_hour_200811_all_modes) <- 
  c("area_id", "2020", "hour_starting", "mode")
names(si_by_area_and_hour_210810_all_modes) <- 
  c("area_id", "2021", "hour_starting", "mode")
names(si_by_area_and_hour_220809_all_modes) <- 
  c("area_id", "2022", "hour_starting", "mode")
names(si_by_area_and_hour_230808_all_modes) <- 
  c("area_id", "2023", "hour_starting", "mode")

si_by_area_and_hour_all_years_all_modes <- left_join(si_by_area_and_hour_150811_all_modes,si_by_area_and_hour_160809_all_modes )
si_by_area_and_hour_all_years_all_modes <- left_join(
  si_by_area_and_hour_all_years_all_modes, 
  si_by_area_and_hour_160809_all_modes)
si_by_area_and_hour_all_years_all_modes <- left_join(
  si_by_area_and_hour_all_years_all_modes, 
  si_by_area_and_hour_170808_all_modes)
si_by_area_and_hour_all_years_all_modes <- left_join(
  si_by_area_and_hour_all_years_all_modes, 
  si_by_area_and_hour_180814_all_modes)
si_by_area_and_hour_all_years_all_modes <- left_join(
  si_by_area_and_hour_all_years_all_modes, 
  si_by_area_and_hour_190813_all_modes)
si_by_area_and_hour_all_years_all_modes <- left_join(
  si_by_area_and_hour_all_years_all_modes, 
  si_by_area_and_hour_200811_all_modes)
si_by_area_and_hour_all_years_all_modes <- left_join(
  si_by_area_and_hour_all_years_all_modes, 
  si_by_area_and_hour_210810_all_modes)
si_by_area_and_hour_all_years_all_modes <- left_join(
  si_by_area_and_hour_all_years_all_modes, 
  si_by_area_and_hour_220809_all_modes)
si_by_area_and_hour_all_years_all_modes <- left_join(
  si_by_area_and_hour_all_years_all_modes, 
  si_by_area_and_hour_230808_all_modes
)

#convert to SA3 aggregation

si_by_area_and_hour_all_years_all_modes_sa3 <- 
  left_join(si_by_area_and_hour_all_years_all_modes, 
            absmapsdata::sa12021 %>% 
              filter(gcc_name_2021 == "Greater Melbourne") %>% 
              select(sa1_code_2021, sa3_code_2021, sa3_name_2021) %>% 
              st_drop_geometry(), 
            join_by(area_id == sa1_code_2021)
  )
          


si_by_area_and_hour_all_years_all_modes_sa3 <- si_by_area_and_hour_all_years_all_modes_sa3 %>%
  group_by(sa3_name_2021, mode) %>% 
  summarise(across(c('2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023'), list(sum = sum)))

names(si_by_area_and_hour_all_years_all_modes_sa3) <- c('sa3_name_2021', 'mode', '2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023')

```

```{r Victoria_within_stats_yearly, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="Victorian GTFS and central Melbourne SA1 zones, SI values second Tuesday in August, 2015-2022, all modes"}

si_by_area_by_year_sa3 <- si_by_area_and_hour_all_years_all_modes_sa3 %>% 
  group_by(sa3_name_2021) %>% 
  summarise(across(c('2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023'), list(sum = sum)))

si_by_area_by_year_sa3_longer <- si_by_area_by_year_sa3 %>% 
  pivot_longer(col=2:10, names_to = "Year", values_to = "SI")


si_by_area_by_year_sa3_longer %>%
  ggwithinstats(
    x = "Year", 
    y = "SI"
  )


```


```{r Melbourne_central_2015_2023, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="Victorian GTFS and central Melbourne SA1 zones, SI values for August 11, 2015, and August 8, 2023"}

map_areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% filter(sa4_name_2021 == "Melbourne - Inner") %>% select(sa1_code_2021),  area_id_field = "sa1_code_2021")

#Join SI to map data
map_si_by_area_2015_2023 <- inner_join(map_areas_of_interest, (si_by_area_by_year_longer %>% filter(Year == "2015" || Year == "2023")))

xlim <- c(144.93343289587824,  144.9946369676684)
ylim <- c(-37.80347733938971, -37.82753754010771)

ggplot() + 
  geom_sf(data=map_si_by_area_2015_2023,
          aes(fill = SI)) +
            facet_wrap(vars(Year), ncol=1) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  coord_sf(xlim = xlim, ylim = ylim)  



```



```{r Melbourne_central_change, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="Victorian GTFS and central Melbourne SA1 zones, SI values for August 8, 2023, by mode"}


si_by_area_by_year$Change_2023 <- (si_by_area_by_year$'2023' - si_by_area_by_year$'2022') / si_by_area_by_year$'2022'
si_by_area_by_year$Change_2022 <- (si_by_area_by_year$'2022' - si_by_area_by_year$'2021') / si_by_area_by_year$'2021'
si_by_area_by_year$Change_2021 <- (si_by_area_by_year$'2021' - si_by_area_by_year$'2020') / si_by_area_by_year$'2020'
si_by_area_by_year$Change_2020 <- (si_by_area_by_year$'2020' - si_by_area_by_year$'2019') /  si_by_area_by_year$'2019'
si_by_area_by_year$Change_2019 <- (si_by_area_by_year$'2019' - si_by_area_by_year$'2018') / si_by_area_by_year$'2018'
si_by_area_by_year$Change_2018 <- (si_by_area_by_year$'2018' - si_by_area_by_year$'2017') / si_by_area_by_year$'2017'
si_by_area_by_year$Change_2017 <- (si_by_area_by_year$'2017' - si_by_area_by_year$'2016') / 
  si_by_area_by_year$'2016'
si_by_area_by_year$Change_2016 <- (si_by_area_by_year$'2016' - si_by_area_by_year$'2015') / si_by_area_by_year$'2015'




```


## Comparing modes
Figure \@ref(fig:Melbourne_CBD_map_230808) SI scores for Tuesday August 8, 2023 by mode for SA1 zones in Central Melbourne.  SI scores are generally higher in the Central Business District (CBD). Results are consistent with: the high number for bus services along the Victoria and Queen Street corridors; the rail stations surrounding the CBD; and tram services that mostly run along the Swanston, Elizabeth, Bourke and Collins Street corridors. 




```{r Greater_Melbourne_within_stats_yearly_bus, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="Victorian GTFS and central Melbourne SA1 zones, SI values second Tuesday in August, 2015-2022, bus only"}


### merge dataframes
si_by_area_and_hour_230808_tram$mode <- "Tram"
si_by_area_and_hour_230808_rail$mode <- "Rail"
si_by_area_and_hour_230808_bus$mode <- "Bus"

si_by_area_and_hour_230808_all_modes <- merge(si_by_area_and_hour_230808_tram, si_by_area_and_hour_230808_rail, all = TRUE)
si_by_area_and_hour_230808_all_modes <- merge(si_by_area_and_hour_230808_all_modes, si_by_area_and_hour_230808_bus,  all = TRUE)


#Join SI to map data
map_si_by_area_and_hour_230808_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_230808_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_230808_all_modes$hour_starting <- hm(map_si_by_area_and_hour_230808_all_modes$hour_starting)
map_si_by_area_and_hour_230808_all_modes$hour_starting <- hour(map_si_by_area_and_hour_230808_all_modes$hour_starting)


#Join SI to map data
map_si_by_area_and_hour_150811_all_modes <- inner_join(map_areas_of_interest, si_by_area_and_hour_150811_all_modes)

#convert hour starting to numeric
map_si_by_area_and_hour_230808_all_modes$hour_starting <- hm(map_si_by_area_and_hour_230808_all_modes$hour_starting)
map_si_by_area_and_hour_230808_all_modes$hour_starting <- hour(map_si_by_area_and_hour_230808_all_modes$hour_starting)



#plot bus, tram and rail
central_melbourne_bus_rail_tram_row <- ggplot() + 
  geom_sf(data=map_si_by_area_and_hour_230808_all_modes,
          aes(fill = SI)) +
            facet_wrap(vars(mode), nrow=1) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  coord_sf(xlim = xlim, ylim = ylim)

central_melbourne_bus_rail_tram_row
 
si_by_area_by_year_bus <- si_by_area_and_hour_all_years_all_modes %>% 
  filter(mode == "bus")
  group_by(area_id) %>% 
  summarise(across(c(x2015, x2016, x2017, x2018, x2019, x2020, x2021, x2022, x2023), list(sum = sum)))

names(si_by_area_by_year_bus) <- c("area_id", 
                                       "2015", 
                                       "2016", 
                                       "2017", 
                                       "2018", 
                                       "2019", 
                                       "2020", 
                                       "2021", 
                                       "2022", 
                                       "2023")
si_by_area_by_year_bus_longer <- si_by_area_by_year_bus %>% 
  pivot_longer(col=2:10, names_to = "Year", values_to = "SI")


si_by_area_by_year_bus %>%
  ggwithinstats(
    x = "Year", 
    y = "SI"
  )

```


```{r Greater_Melbourne_within_stats_yearly_rail, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="Victorian GTFS and central Melbourne SA1 zones, SI values second Tuesday in August, 2015-2022, rail only"}


 
si_by_area_by_year_rail <- si_by_area_and_hour_all_years_all_modes %>% 
  filter(mode == "rail")
  group_by(area_id) %>% 
  summarise(across(c(x2015, x2016, x2017, x2018, x2019, x2020, x2021, x2022, x2023), list(sum = sum)))

names(si_by_area_by_year_rail) <- c("area_id", 
                                       "2015", 
                                       "2016", 
                                       "2017", 
                                       "2018", 
                                       "2019", 
                                       "2020", 
                                       "2021", 
                                       "2022", 
                                       "2023")
si_by_area_by_year_rail_longer <- si_by_area_by_year_rail %>% 
  pivot_longer(col=2:10, names_to = "Year", values_to = "SI")


si_by_area_by_year_rail %>%
  ggwithinstats(
    x = "Year", 
    y = "SI"
  )

```
 

```{r Greater_Melbourne_within_stats_yearly_tram, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="Victorian GTFS and central Melbourne SA1 zones, SI values second Tuesday in August, 2015-2022, tram"}


 
si_by_area_by_year_tram <- si_by_area_and_hour_all_years_all_modes %>% 
  filter(mode == "tram")
  group_by(area_id) %>% 
  summarise(across(c(x2015, x2016, x2017, x2018, x2019, x2020, x2021, x2022, x2023), list(sum = sum)))

names(si_by_area_by_year_tram) <- c("area_id", 
                                       "2015", 
                                       "2016", 
                                       "2017", 
                                       "2018", 
                                       "2019", 
                                       "2020", 
                                       "2021", 
                                       "2022", 
                                       "2023")
si_by_area_by_year_tram_longer <- si_by_area_by_year_tram %>% 
  pivot_longer(col=2:10, names_to = "Year", values_to = "SI")


si_by_area_by_year_tram %>%
  ggwithinstats(
    x = "Year", 
    y = "SI"
  )

```
  
 

## Compating regions 



```{r Melbourne_City_sa2_230808_by_hour, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones, SI values for Tuesday August 8, 2023, by hour, 5am to midnight", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include=FALSE}


#Join SI to ABS names data
si_by_area_and_hour_230808_sa2  <- left_join(
  si_by_area_and_hour_230808,
  (absmapsdata::sa12021 %>% 
     filter(gcc_name_2021 == "Greater Melbourne") %>% 
     select(sa1_code_2021, sa2_code_2021, sa2_name_2021, sa3_name_2021) %>%
     st_drop_geometry()), 
  by = join_by(area_id == sa1_code_2021)
)



#aggregate SI by SA2 for Melbourne City only
si_by_area_and_hour_230808_sa2 <- si_by_area_and_hour_230808_sa2 %>% 
  filter(sa3_name_2021 == "Melbourne City") %>%
  aggregate(SI ~ hour_starting+sa2_name_2021+sa3_name_2021,
  FUN = sum) %>%
  as_tibble()

#convert hour starting to numeric
si_by_area_and_hour_230808_sa2$hour_starting_numeric <- hm(si_by_area_and_hour_230808_sa2$hour_starting)
si_by_area_and_hour_230808_sa2$hour_starting_numeric <- hour(si_by_area_and_hour_230808_sa2$hour_starting_numeric)

ggwithinstats(
  data = si_by_area_and_hour_230808_sa2 %>% 
    filter(hour_starting_numeric > 5 & 
            hour_starting_numeric < 24),
  x = hour_starting_numeric,
  y = SI,
  #type = "nonparametric", ## type of statistical test
  xlab = "Hour starting", ## label for the x-axis
  ylab = "SI", ## label for the y-axis
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  pairwise.display = "none"
)  
```



```{r Melbourne_230808_by_hour, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones (except Melbourne City), SI values for Tuesday August 8, 2023, by hour, 5am to midnight", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include=FALSE}


#Join SI to ABS names data
si_by_area_and_hour_230808_sa3  <- left_join(
  si_by_area_and_hour_230808,
  (absmapsdata::sa12021 %>% 
     filter(gcc_name_2021 == "Greater Melbourne") %>% 
     select(sa1_code_2021, sa3_code_2021, sa3_name_2021, sa4_name_2021) %>%
     st_drop_geometry()), 
  by = join_by(area_id == sa1_code_2021)
)



#aggregate SI by SA3
si_by_area_and_hour_230808_sa3 <- si_by_area_and_hour_230808_sa3 %>% 
  aggregate(SI ~ hour_starting+sa3_name_2021+sa4_name_2021,
  FUN = sum) %>%
  as_tibble()

#convert hour starting to numeric
si_by_area_and_hour_230808_sa3$hour_starting_numeric <- hm(si_by_area_and_hour_230808_sa3$hour_starting)
si_by_area_and_hour_230808_sa3$hour_starting_numeric <- hour(si_by_area_and_hour_230808_sa3$hour_starting_numeric)

ggwithinstats(
  data = si_by_area_and_hour_230808_sa3 %>% 
    filter(sa3_name_2021 != "Melbourne City") %>%
    filter(hour_starting_numeric > 5 & 
            hour_starting_numeric < 24),
  x = hour_starting_numeric,
  y = SI,
  #type = "nonparametric", ## type of statistical test
  xlab = "Hour starting", ## label for the x-axis
  ylab = "SI", ## label for the y-axis
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  pairwise.display = "none"
)  

```


```{r greater_melbourne_230808_sa3_by_hour_percentatages, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne, SI values for Tuesday August 8, 2023, by hour as a percentage of the full day", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = FALSE}

si_by_area_and_hour_230808_sa3_wider <- si_by_area_and_hour_230808_sa3 %>%
  select(sa3_name_2021, hour_starting_numeric, SI) %>%
  pivot_wider(names_from = hour_starting_numeric, values_from = SI)


si_by_area_and_hour_230808_sa3_wider_percentages <- si_by_area_and_hour_230808_sa3_wider %>% 
  adorn_percentages() 

si_by_area_and_hour_230808_sa3_percentages <- si_by_area_and_hour_230808_sa3_wider_percentages %>% 
  pivot_longer(cols = 2:ncol(si_by_area_and_hour_230808_sa3_wider_percentages), 
               names_to = "hour_starting", 
               values_to = "SI")

si_by_area_and_hour_230808_sa3_percentages$hour_starting <- si_by_area_and_hour_230808_sa3_percentages$hour_starting %>% as.numeric()

ggwithinstats(
  data = si_by_area_and_hour_230808_sa3_percentages %>% 
    filter(hour_starting > 4 & hour_starting < 22), ## data frame from which variables are taken
  x = hour_starting, ## predictor/independent variable
  y = SI, ## dependent variable
  xlab = "Population", ## label for the x-axis
  ylab = "Percent of SI score for full day", ## label for the y-axis
  label.var = sa3_name_2021, ## variable to use for labeling data points
  # label.expression = Population > 15000 & SI < 5000, ## expression for deciding which points to label
  point.label.args = list(alpha = 0.7, size = 4, color = "grey50"),
  xfill = "#CC79A7", ## fill for marginals on the x-axis
  yfill = "#009E73", ## fill for marginals on the y-axis
  pairwise.display = "none"
) 

```



```{r greater_melbourne_230808_8am_versus_total_scatterplot, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne (except Melbourne City), SI values for Tuesday August 8, 2023 8 to 9am versus all day", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = FALSE}


ggscatterstats(
  data = si_by_area_and_hour_230808_sa3_wider_percentages,
  x = `8`, ## predictor/independent variable
  y = `20`, ## dependent variable
  xlab = "8-9am", ## label for the x-axis
  ylab = "8-9pm", ## label for the y-axis
  label.var = sa3_name_2021, ## variable to use for labeling data points
  # label.expression = Population > 15000 & SI < 5000, ## expression for deciding which points to label
  point.label.args = list(alpha = 0.7, size = 4, color = "grey50"),
  xfill = "#CC79A7", ## fill for marginals on the x-axis
  yfill = "#009E73", ## fill for marginals on the y-axis
) 

```



```{r greater_melbourne_230808_8am_versus_total_scatterplot_by_hour, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne (except Melbourne City), SI values for Tuesday August 8, 2023 8 to 9am versus all day", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = FALSE}


si_by_area_and_hour_230808_sa3_wider <- si_by_area_and_hour_230808_sa3_wider %>% 
  adorn_totals(where = "col") 

ggscatterstats(
  data = si_by_area_and_hour_230808_sa3_wider %>% 
    filter(sa3_name_2021 != "Melbourne City"), ## data frame from which variables are taken
  x = `8`, ## predictor/independent variable
  y = Total, ## dependent variable
  xlab = "8-9am", ## label for the x-axis
  ylab = "Full day", ## label for the y-axis
  # label.var = sa3_name_2021, ## variable to use for labeling data points
  # label.expression = Population > 15000 & SI < 5000, ## expression for deciding which points to label
  point.label.args = list(alpha = 0.7, size = 4, color = "grey50"),
  xfill = "#CC79A7", ## fill for marginals on the x-axis
  yfill = "#009E73", ## fill for marginals on the y-axis
) 

```


```{r greater_melbourne_230808_5pm_versus_total_scatterplot, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne (except Melbourne City), SI values for Tuesday August 8, 2023 5 to 6pm versus all day", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = FALSE}

ggscatterstats(
  data = si_by_area_and_hour_230808_sa3_wider %>% 
    filter(sa3_name_2021 != "Melbourne City"), ## data frame from which variables are taken
  x = `5`, ## predictor/independent variable
  y = Total, ## dependent variable
  xlab = "5-6pm", ## label for the x-axis
  ylab = "Full day", ## label for the y-axis
   label.var = sa3_name_2021, ## variable to use for labeling data points
  # label.expression = Population > 15000 & SI < 5000, ## expression for deciding which points to label
  point.label.args = list(alpha = 0.7, size = 4, color = "grey50"),
  xfill = "#CC79A7", ## fill for marginals on the x-axis
  yfill = "#009E73", ## fill for marginals on the y-axis
) 

```


```{r greater_melbourne_230808_9pm_versus_total_scatterplot, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne (except Melbourne City), SI values for Tuesday August 8, 2023 9 to 10pm versus all day", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = FALSE}

ggscatterstats(
  data = si_by_area_and_hour_230808_sa3_wider %>% 
    filter(sa3_name_2021 != "Melbourne City"), ## data frame from which variables are taken
  x = `21`, ## predictor/independent variable
  y = Total, ## dependent variable
  xlab = "9-10pm", ## label for the x-axis
  ylab = "Full day", ## label for the y-axis
   label.var = sa3_name_2021, ## variable to use for labeling data points
  # label.expression = Population > 15000 & SI < 5000, ## expression for deciding which points to label
  point.label.args = list(alpha = 0.7, size = 4, color = "grey50"),
  xfill = "#CC79A7", ## fill for marginals on the x-axis
  yfill = "#009E73", ## fill for marginals on the y-axis
) 
```



```{r gghistostats_greater_melbourne_230808, crop = TRUE, fig.cap = "Victorian GTFS and SA1 zones within Greater Melbourne, SI values for Tuesday August 8, 2023", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}

#aggregate SI by area
si_by_area_230808 <- si_by_area_and_hour_230808 %>%
  aggregate(SI ~ area_id, FUN = sum) %>%
  as_tibble()


#Join SI to ABS names data
si_by_area_230808 <- left_join(si_by_area_230808, 
                               (absmapsdata::sa12021 %>% 
                                 filter(gcc_name_2021 == "Greater Melbourne") %>% 
                                 select(sa1_code_2021, sa3_name_2021, sa4_name_2021,
                                        areasqkm_2021, cent_lat, cent_long) %>%
                                 st_drop_geometry()), 
                               by = join_by(area_id == sa1_code_2021)
)

#aggregate SI by SA3
si_by_area_230808_sa3 <- si_by_area_230808 %>%
  aggregate(SI ~ sa3_name_2021, FUN = sum) %>%
  as_tibble()


#Join SI to ABS names data
si_by_area_230808_sa3 <- left_join(si_by_area_230808_sa3, 
                               (absmapsdata::sa32021 %>% 
                                 filter(gcc_name_2021 == "Greater Melbourne") %>% 
                                 select(sa3_name_2021, sa3_code_2021, sa4_name_2021) %>%
                                 st_drop_geometry()), 
                               by = join_by(sa3_name_2021 == sa3_name_2021)
)



#Join SI to map data
map_areas_of_interest_sa3 <- absmapsdata::sa32021 %>% filter(gcc_name_2021 == "Greater Melbourne") %>% select(sa3_name_2021, sa4_name_2021, geometry)

map_si_by_area_230808_sa3 <- inner_join(map_areas_of_interest_sa3, si_by_area_230808_sa3)


#load_population_data
X2021Census_G01_VIC_SA1 <- read_csv(
  "data/2021_GCP_SA1_for_VIC_short-header/2021 Census GCP Statistical Area 1 for VIC/2021Census_G01_VIC_SA1.csv")
X2021Census_G01_VIC_SA1$SA1_CODE_2021 <- as.character(
  X2021Census_G01_VIC_SA1$SA1_CODE_2021)


#aggregate SI by area
si_by_area_230808 <- si_by_area_and_hour_230808 %>%
  aggregate(SI ~ area_id, FUN = sum) %>%
  as_tibble()


#join_to_SI_scores
si_by_area_230808_pop <- left_join(si_by_area_230808,
                               (X2021Census_G01_VIC_SA1 %>% 
                                  select(SA1_CODE_2021, Tot_P_P)), 
                                by = join_by(area_id == SA1_CODE_2021)
                                )

names(si_by_area_230808_pop) <- c("area_id", "SI", "Population")



#Join SI to ABS names data
si_by_area_230808_pop <- left_join(si_by_area_230808_pop, 
                               (absmapsdata::sa12021 %>% 
                                 filter(gcc_name_2021 == "Greater Melbourne") %>% 
                                 select(sa1_code_2021, sa3_name_2021, sa4_name_2021) %>%
                                 st_drop_geometry()), 
                               by = join_by(area_id == sa1_code_2021)
)


#si_by_area_230808_pop %>% 
#  select(Population, SI) %>%
#  tbl_summary(type = all_continuous() ~ "continuous2",
#    statistic = all_continuous() ~ c("{median} ({p25}, {p75})", "{Skew}", "{mean} ({sd})", "{p10}, {p90}", "{p5}, {p95}", "{p1},{p99}","{min},{max}")
#  ) 



#ggscatterstats(
#  data = si_by_area_230808_pop, ## data frame from which variables are taken
#  x = Population, ## predictor/independent variable
#  y = SI, ## dependent variable
#  xlab = "Population", ## label for the x-axis
#  ylab = "SI score", ## label for the y-axis
#  label.var = sa3_name_2021, ## variable to use for labeling data points
#  label.expression = Population > 600 & SI < 30, ## expression for deciding which points to label
#  point.label.args = list(alpha = 0.7, size = 4, color = "grey50"),
#  xfill = "#CC79A7", ## fill for marginals on the x-axis
#  yfill = "#009E73", ## fill for marginals on the y-axis
#) +
#  scale_x_log10() +
# scale_y_log10()



```

```{r Gini_coefficients, crop = TRUE, fig.cap = "Victorian GTFS and SA1 zones within Greater Melbourne, SI values for Tuesday August 8, 2023, Lorenz plot", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}


gini_plot_greater_melbourne_sa1 <- ggplot(si_by_area_230808_pop %>% 
        select(SI, Population), 
       aes(x = SI, n = Population)) + 
         stat_lorenz()  +
  geom_abline(linetype = "dashed") +
  theme_bw() +
  labs(x = "Cumulative share of Population", y = "Cumulative share of SI") +
  #scale_x_continuous(labels = scales::percent()) + 
  #scale_y_continuous(labels = scales::percent()) + 
  annotate_ineq(data_ineq = (si_by_area_230808_pop %>% 
        select(SI, Population))$SI, 
                freq_ineq = (si_by_area_230808_pop %>% 
        select(SI, Population))$Population,
                measure_ineq = "Gini", 
                color = "red",
                family = theme_get()$text[["family"]],
                size = theme_get()$text[["size"]] / 2,
                fontface = "italic") 



```


```{r map_greater_melbourne_230808_by_sa3, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne, SI values for Tuesday August 8, 2023", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}


map_areas_of_interest_sa3 <- absmapsdata::sa32021 %>% filter(gcc_name_2021 == "Greater Melbourne") %>% select(sa3_name_2021, sa4_name_2021, geometry)

#Join SI to map data
map_si_by_area_230808_sa3 <- inner_join(map_areas_of_interest_sa3,
                                        si_by_area_230808_sa3)



my_breaks = c(1, 10, 100, 1000, 10000, 100000, 1000000)

#plot
greater_melbourne_sa3_SI_map <- ggplot() + 
  geom_sf(data=map_si_by_area_230808_sa3,
          aes(fill = SI)) + 
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  scale_fill_gradient(name = "SI", trans = "log", breaks = my_breaks, labels = my_breaks)


#aggregate SI by area
si_by_area_230808_pop_sa3 <- si_by_area_230808_pop %>%
  aggregate(Population ~ sa3_name_2021, FUN = sum) %>%
  as_tibble()

#Join Population to SI and map data
map_si_by_area_230808_sa3 <- inner_join(map_si_by_area_230808_sa3,
                                        si_by_area_230808_pop_sa3)

# Statistics
#map_si_by_area_230808_sa3 %>% 
#  st_drop_geometry() %>%
#  select(Population, SI) %>%
#  tbl_summary(type = all_continuous() ~ "continuous2",
#    statistic = all_continuous() ~ c("{median} ({p25}, {p75})", "{Skew}", "{mean} ({sd})", #"{p10}, {p90}", "{p5}, {p95}", "{p1}, {p99}","{min}, {max}")
#  ) 

my_breaks = c(10, 100, 1000, 10000, 100000, 200000)


#plot
greater_melbourne_sa3_population_map <- ggplot() + 
  geom_sf(data=map_si_by_area_230808_sa3,
          aes(fill = Population)) + 
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) +
  scale_fill_gradient(name = "Population", trans = "log", breaks = my_breaks, labels = my_breaks)




#plot
p7 <- ggplot() + 
  geom_sf(data=map_si_by_area_230808_sa3,
          aes(fill = log(SI / Population))) + 
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  ) 




```

```{r greater_melbourne_230808_by_sa3_scatterplot, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne, SI values for Tuesday August 8, 2023 and 2021 census population ", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}



greater_melbourne_sa3_population_SI_scatter <- ggscatterstats(
  data = map_si_by_area_230808_sa3 %>% st_drop_geometry(), ## data frame from which variables are taken
  x = Population, ## predictor/independent variable
  y = SI, ## dependent variable
  xlab = "Population", ## label for the x-axis
  ylab = "SI score", ## label for the y-axis
  label.var = sa3_name_2021, ## variable to use for labeling data points
  # label.expression = Population > 15000 & SI < 5000, ## expression for deciding which points to label
  point.label.args = list(alpha = 0.7, size = 4, color = "grey50"),
  xfill = "#CC79A7", ## fill for marginals on the x-axis
  yfill = "#009E73", ## fill for marginals on the y-axis
) +
  scale_x_log10() +
  scale_y_log10()

#p8 + p7


```


```{r greater_melbourne_230808_by_gini, crop = TRUE, fig.cap = "Victorian GTFS and SA1 zones within Greater Melbourne, SI values for Tuesday August 8, 2023 and 2021 census population, Lorenz plot ", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}

gini_plot_greater_melbourne_sa1

```

Lorenz curves and the Gini coefficient are commonly used to examine equality. REFERENCES TO  Figure \@ref{fig:greater_melbourne_230808_by_sa3_population_and_si_plot} compares the SI score and


Figure \@ref{fig:greater_melbourne_230808_by_sa3_population_and_si_plot} compares the SI score and 

```{r greater_melbourne_230808_by_sa3_population_and_si_plot, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne, SI values for Tuesday August 8, 2023 and 2021 census population ", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}


greater_melbourne_sa3_SI_map + greater_melbourne_sa3_population_map 

```

```{r greater_melbourne_230808_by_gini_and_scatter, crop = TRUE, fig.cap = "Victorian GTFS and SA3 zones within Greater Melbourne, SI values for Tuesday August 8, 2023 and 2021 census population ", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}

greater_melbourne_sa3_population_SI_scatter



```


### Yearly changes

## Comparing accessibility

### Yearly changes

## Indexes and comparing cities

### Yearly changes

## Purpose of transit in the city's transport policy

### Yearly changes



# Discussion and conclusions




# References {-}



```{r, include=FALSE}
knitr::write_bib(file = 'packages.bib')
```

