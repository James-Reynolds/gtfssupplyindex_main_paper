---
title: "Leveraging GTFS to explore spatial patterns in transit supply with respect to social needs"
author:
  - name: James Reynolds
    email: james.reynolds@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    correspondingauthor: false
    footnote: 1
  - name: Yanda Qu
    email: yanda.qu@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    footnote: 2
  - name: Graham Currie
    email: graham.currie@monash.edu
    affiliation: Public Transport Research Group (PTRG)
    correspondingauthor: true
    footnote: 3
address:
  - code: Public Transport Research Group (PTRG)
    organization: Public Transport Research Group (PTRG), Institute of Transport Studies, Department of Civil Engineering Engineering, Monash University
    addressline: Clayton Campus
    city: Melbourne 
    state: Victoria
    postcode: 3800
    country: Australia
  
footnote:
  - code: 1
    text: "Research Fellow"
  - code: 2
    text: "PhD Student"
  - code: 3
    text: "Professor"
abstract: |
  This is the abstract.

  It consists of two paragraphs.
keywords: 
  - keyword1
  - keyword2
journal: "Transport Geography?"
date: "`r Sys.Date()`"
classoption: preprint, 3p, authoryear
bibliography: References.bib, packages.bib
linenumbers: false
numbersections: true
# Use a CSL with `citation_package = "default"`
# csl: https://www.zotero.org/styles/elsevier-harvard
output: 
  rticles::elsevier_article:
    keep_tex: true
    citation_package: natbib
    extra_dependencies: "subfig"
---



```{r setup, include=FALSE}
library(tidyverse)
library(tidytransit)
library(sp)
library(strayr)
library(ptinpoly)
library(magrittr)
library(ggplot2)
library(sf)
library(ASGS.foyer)
library(raster)
library(ggmap)
library(units)
library(janitor)
library(mapview)
library(ggstatsplot)
library(gtsummary)
library(moments)
library(scales)
library(gtfstools)
library(lubridate)
library(kableExtra)
library(knitr)
library(readxl)
library(readr)
library(dplyr)
library(devtools)
library(gtfssupplyindex)
library(readabs)
library(gglorenz)
library(DescTools)
library(RColorBrewer)
library(lsr)
library(ggpubr)
library(viridis)
library(geosphere)


# invalidate cache when the tufte version changes
#knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))

```



# Introduction
In many parts of 
cities and towns 
a key reason for providing 
public transport services 
is to providing a basic level of mobility 
for those who cannot otherwise drive themselves
Some of the services, facilities 
and activities 
that are needed for people 
to meet their basic needs 
and participate in society 
may be within walking or cycling distance. 
However, in many places, 
especially those with 
low-density landuse patterns 
or limited transit servcies, 
it may be difficult 
or even impossible 
to get around 
without a private vehicle. 
As well as lack of 
access to an automobile, 
disability, 
youth or old age, 
socio-economic status, 
lack of a drivers license, 
and many other factors 
might mean
someone is
reliant on 
transit services 
for some or all of their travel 
to and from places 
beyond their local neighbourhood. 

Adopting 
social equity-focused approaches 
to transport planning
might suggest targeting 
higher transit service levels
towards spatial areas 
where there are higher 
social and transport needs.  
Approaches for assessing 
spatial gaps between social needs for transport 
and what transit is supplied have 
been reported in previous research, 
including in
@Currie2003Hobart, 
@Currie2004Gap, 
@Currie2007Identifying 
and @currie2010identifying.
These publications presented a
transit Supply Index (SI) 
and used to identify geographic areas 
in a few Australian cities 
where there were 
very high social needs for transport, 
but very little transit service, 
or no transit at all. 
This approach suggested 
a new way for transit planners
to identify 
and prioritise locations, 
targetted towards improving mobility
for populations 
who might not 
have sufficient mobility 
to meet their basic needs 
or fully participate in society. 




However, in almost two decades since the SI was developed
there does not appear to have been much further use 
of this approach. 
It is also unclear whether
gaps between social needs and transit supply 
have increased or reduced 
in Australian cities; 
or if the spatial patterns 
identified in Hobart [@Currie2003Hobart; @Currie2004Gap] 
and Melbourne [@Currie2007Identifying; @currie2010identifying] 
are similar to those in other places.


This may in part be because 
applying such methodologies elsewhere 
would, at the time, 
likely have required 
bespoke data collection, 
cleaning and analysis. 
Transit timetables 
were typically publicly available in 
paper and/or PDF formats, 
while the analyses reported in 
@Currie2003Hobart, 
@Currie2004Gap, 
@Currie2007Identifying 
and @currie2010identifying 
appear to have been mostly based 
on special data provided 
directly to the research 
by transit operators 
and authorities in each location.
Regardless, 
the volume of spatial and service 
data and processing 
needed to produce 
a social needs-gap analysis 
may have put such analyses 
beyond reach in most places. 

Nowadays, however, 
the General Transit Feed Specification (GTFS)
and the internet
allows timetable data 
to be published in 
a standardized 
and accessible format. 
More than 10,000 transit agencies 
publically release data 
this way. 
Various tools for manipulating such data 
are also now available, 
including software for 
validating, 
analysing 
and visualizating GTFS, 
as well as a separate standard 
(GTFS-Realtime) for sharing 
live vehicle locations [@GTFS].

However, software tools
for examining spatial 
patterns and gaps 
in transit supply 
with respecial to 
social needs for transport
appears limited.  
This gap and the lack of 
direct follow up 
to @Currie2003Hobart, 
@Currie2004Gap, 
@Currie2007Identifying 
and @currie2010identifying 
provide the motivation 
for the research reported in this paper.  
This research included 
the developement of a new R package (gtfssupplyindex) 
fpr calculating SI scores. 
Also presented in this paper 
are results for Greater Melbourne in 2016 and 2021, 
matching the most recent censuses, 
comparable to the 2006 analysis
reported in @currie2010identifying.
Comparisons are also made to other parts of Australia, 
so as to explore whether findings about Greater Melbourne are generalizable. 

The remainder of this paper is structured as follows:
the next section outlines the background to this research,
including the formulation of the Transit Supply Index (SI). 
Section 3 describes the study methodology, 
followed by presentation of results in Section 4 
and discussion in Section 5. 
Limitations of this study, 
directions for future research and 
a brief conclusion are provided in Section 6. 

# Background

## Transit metrics
There are 
many metrics 
available for benchmarking transit services, 
including: those in 
the Transit Cooperative Research Program (TCRP) Report 88 guidebook 
on developing performance-measurement systems [@Ryus:2003aa] 
and in the Transit Capacity and Quality of Service Manual (TCQSM)[@TCQSM:2013]; 
those used across
benchmarking databases and programs 
(e.g. @Florida-Transit-Information-System:2018aa, @UITP:2015aa @Imperial-College-London:2023aa;
and the results available on the .Transit Score website [@WalkScore:2023tg].
The Fielding Triangle [@FieldingGordonJ1987Mpts] 
provides a framework 
for combining indicators of 
service inputs, 
outputs 
and consumption 
to describe cost efficiency, 
cost effectiveness and
service effectiveness. 
More broadly: @Litman:2003ab 
and @Litman:2016aa 
discuss some of the traffic, 
mobility, 
accessibility, 
social equity, 
strategic planning 
and other rational decision-making-based
perspectives underling transport indicators; 
@Reynolds:2017ah extends 
these into models of how 
institutionalism, 
incrementalism 
and other public policy analysis concepts 
might apply to decision-making processes 
relating to transit prioritization; 
@GuzmanLuisA.2017Aeit developed a measure of accessibility 
in the context of policy development 
and social equity 
for Latin American Bus Rapid Transit (BRT) networks; and 
@Creutzig2020streetspaceallocation
introduced street space allocation metrics 
based around ten ethical principles. 

However, 
many of these metrics 
may be difficult to calculate, 
explain or understand, 
especially for those who are not planners, engineers 
or other technical specialists. 
Where pre-calculated transit metrics 
are immediately available, 
such as on a website or 
other online platform, 
it may not be possible
to independently generate scores, 
for instance to assess proposed system changes. 
Contrasting examples are provided by the metrics in the 
TCQSM 
and the Transit Score metric [@WalkScore:2023tg]:

- Transit Scores are readily available on the Transit Score website for locations with a published GTFS feed. 
The meaning of these Transit Scores 
also appears easy to explain, 
with the highest possible score of 100 
representing the sort of transit accessibility that might be xperienced in the center of New York. 
However, 
the Transit Score algorithm 
is a black box, 
and scores cannot be calculated independently
or generated 
for proposed changes to networks. 

- the TCQSM provides a wide range of metrics 
for measuring different aspects of a transit system. 
The TCQSM scores themselves appear easy to understand or explain, 
ranging from A (good) to F (bad), 
although the large number of metrics 
might be somewhat overwhelming for some users.
The scores, however, 
can be calculated independently, given sufficient data. 

@Wong:2013aa provides an example of what can be done 
with GTFS data, 
open metrics and coding by 
reporting the distribution of
various TCQSM metrics 
across 50 USA transit operators. 
Code used in the 
@Wong:2013aa analysis 
is available 
for those who might wish 
to produce a similar study 
for other locations and systems. 
Producing code that 
allows similar calculations 
from GTFS data, 
except for the SI metric, 
is included in the objectives of this study.


## The Transit Suppy Index
A generalized form of the SI equation, adapted from @currie2010identifying, is: 

  $$SI_{area, time} = \sum{\frac{Area_{Bn}}{Area_{area}}*SL_{n, time}}$$

where:

- $SI_{area, time}$ is the Supply Index for the area of interest 
and a given period of time;

- $Area_{Bn}$ is the buffer area for each stop (n) within the area of interest 
(in @currie2010identifying this was based on 
a radius of 400 metres for bus and tram stops, 
and 800 metres for railway stations);

- $Area_{area}$ is the area of the area of interest; and

- $SL_{n,time}$ is the number of transit arrivals for each stop 
for a given time period.

```{r Currie_map_SI, fig.cap = "Distribution of supply measure scores – Metropolitan Melbourne (2006), Source: Currie (2010)",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/Currie2010SI.png")

```

@currie2010identifying reported SI scores across Greater Melbourne in 2006, as shown in 
Figure \ref{fig:Currie_map_SI}, 
and identifing a general pattern of:
more transit supply 
in the middle and inner suburbs
and along passenger railway lines; and 
outer areas tending to have very low SI scores 
or no transit supply at all. 

## Social need and needs gap

As well as measuring transit supply, @currie2010identifying also 
assessed the social need for transit 
across Greater Melbourne using: 
the Australian Bureaus of Statistics' Index of Related Socio-Economic Advantage/Disadvantage (IRSAD) and 
a transport needs index derived 
from eight weighted indicators.
The spatial distribution of this 
composite social needs index in 2006, 
reproduced in Figure \ref{fig:Currie_maps_needs), 
indicates areas of 
above average, 
high and
very high 
social needs 
in 2006 were located in: 
some outer areas, 
particularly in the east and south-east; 
and in some middle areas in the south-east,
north and west. 
@currie2010identifying also identified 
areas with very high transport needs, 
but very low or no transit supply,  
as reproduced in Figure \ref{fig:Currie_map_gap}. 
This indicated areas 
where service gaps might be of particular concern, 
Most of these were located in outer parts of Melbourne 
in the north-east, south-east and south, 
although there were also some pockets 
in the middle suburbs in the west, north and south east.


```{r Currie_chart_gap, fig.cap = "Log supply score and need index values – Melbourne needs-gap study, Source: Currie (2010)",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

#knitr::include_graphics("graphics/Currie2010chart.png")

```


```{r Currie_map_needs, fig.cap = "Distribution of categories of composite social need index scores in 2006, Source: Currie (2010)",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/Currie2010Needs.png")

```


```{r Currie_map_gap, fig.cap = "Melbourne needs-gap in 2006 – very high transport need areas with zero or very low public transport supply, Source: Currie (2010)",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/Currie2010gap.png")

```
 
Overall @currie2010identifying found that 
"8.2% of Melbourne residents have ‘very high’ needs 
but ‘zero’, ‘low’ or ‘very low’ public transport supply."
Using this methodology in transit planning appraoch was also stated as being 
"substantially more useful than the presentation of anecdotal evidence, 
which is the most common means 
of identifying transport needs 
in local transport studies throughout the world."[@currie2010identifying]

However, it does not appear that this approach 
has been widely adopted 
in practice 
or further developed by researchers. 
Our suspicion is that while the SI has a relatively simple formula 
and requires only geographic and timetable data, 
the lack of a software tool to perform these calculations
may be part of the reason 
that it has not been more widely adopted.
It is also unclear 
whether the patterns in Melbourne 
identified in @currie2010identifying, 
have changed 
since the 2006 analysis. 
Developing a software tool 
to calculate SI tools from GTFS data, 
and then using it to comparing current conditions and other locations 
to the findings of @currie2010identifying, 
therefore, provides motivation 
for this research.


# Methodology

This study developed
a package of tools 
for calculating the SI from GTFS data 
using the R programming language [@R-base].
The recommendations of @wickham2023r 
informed the package setup and 
development approach. 
Various existing packages 
and code examples
were relied upon including: 
the sf package [@R-sf] for geospatial analysis; 
the tidyverse [@tidyverse2019]; 
gtfstools [@R-gtfstools]; and 
tidytransit [@R-tidytransit]. 
Australian Bureau of Statistics (ABS) data was also used, sourced via the strayr 
and absmapsdata packages [@r-strayr].

Two cases were used 
during the code development and testing, 
such that results might be generated for real GTFS data.
These are: 

- the Mornington Peninsula Tourist Railway GTFS feed; and 

- the Public Transport Victoria (PTV) GTFS feed, 
both in Victoria, Australia. 


Both were selected primarily for convenience, 
given that the authors are familiar with 
the typical service patterns and geography 
in Greater Melbourne.
Adopting the Mornington Peninsula Tourist Railway network, which consists of only three stations, 
also facilitated hand calculation of the SI 
as a cross-check of the results 
produced by the developed package. 

Figure \@ref(Melbourne_map)) shows the areas of interest 
relevant to the code development and testing, 
and selected railway stations. 
Statistical Area 1 (SA1) zones^[SA1 zones are the smallest geographical areas 
for which results are reported in the Australian census.] 
were adopted 
from the Australian Bureau of Statistics [@ABSmaps] 
as the areas of interest, 
while SA3 zones^[These are generally similar to Local Government Area (LGA) boundaries.] where used for aggregation. 


```{r Melbourne_map, fig.cap = "Areas of interest",  echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, out.width='100%'}

knitr::include_graphics("graphics/all_maps.png")

```

### Mornington Penninsula Tourist Railway

The Morning Peninsula Tourist Railway 
is in the outer south-east of Melbourne, 
running on Sundays and Wednesdays 
between Mornington and Moorooduc, 
with an intermediate stop at Tanti Park^[see https://transitfeeds.com/p/mornington-railway/806/latest/stops].
A GTFS feed from 2018 
was selected for the purposes of tests,
and for demonstrating the code and outputs reported here.

```{r mornington_calc, crop = TRUE, fig.cap = "SA1 zones (red), location of Mornington Tourist Railway Stations (black) and boundary of zones within 800m catchment (blue)", fig.width = 3, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}
### ---------------- get abs data for Mornington Peninsula
#options(timeout = 1000)
#remotes::install_github("wfmackey/absmapsdata")

#get_mornington_sa1 <- function(){
#  mornington_sa12021 <- absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021)
#  sf::st_write(mornington_sa12021, "inst/extdata/mornington_sa12021.geojson", append=FALSE)
#  return(mornington_sa12021)
#}
#get_mornington_sa3 <- function(){
#  mornington_sa32021 <- absmapsdata::sa32021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa3_code_2021)
#  sf::st_write(mornington_sa32021, "inst/extdata/mornington_sa32021.geojson", append=FALSE)
#  return(mornington_sa32021)
#}

### ---------------- load SA3 abs maps data for just mornington peninsula
areas_of_interest <- load_areas_of_interest(areas_of_interest = absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021), 
  area_id_field = "sa1_code_2021")

# map the areas_of_interest
map <- areas_of_interest %>% 
  ggplot() +
  geom_sf(aes(geometry = geometry))
#map
#set the EPSG to transform from lat/lon to metres
EPSG_for_transform = 28355

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))
stops_as_sf_mornington <-  list_gtfs[[1]]$stops %>% 
  tidytransit::stops_as_sf()

#map the stops on the ABS data
#map + 
#  geom_sf(data = stops_as_sf_mornington, aes(geometry = geometry))


stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355
)

```

### Public Transport Victoria (PTV)
The Victorian GTFS feed, 
published by Public Transport Victoria (PTV) and 
with historical feeds sourced via @transitfeeds_victoria:2023aa, was used for analysis of Greater Melbourne and Victoria. SI scores were obtained for the weeks starting on the day of the census in 2016 and 2021, which were on Tuesday 9th and 10th of August respectively. 

```{r fix_ptv_data_Victoria_230804, eval = FALSE, echo = FALSE}


ptv_230804 <- tidytransit::read_gtfs("data/ptv_230804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_230804_duplicated_stops <- tabyl(ptv_230804$stops$stop_id) %>% filter (n>1)
names(ptv_230804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_230804_duplicated_stops <- left_join(ptv_230804_duplicated_stops, ptv_230804$stops)

##discard duplicates
ptv_230804$stops <- ptv_230804$stops[!duplicated(ptv_230804$stops$stop_id),]

## Write gtfs back to file
ptv_230804 <- as_tidygtfs(ptv_230804)
tidytransit::write_gtfs(ptv_230804, "data/ptv_230804/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_all_of_Victoria_230808, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_230808 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230808")

si_by_area_and_hour_230808_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230808_tram")

si_by_area_and_hour_230808_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230808_rail")

si_by_area_and_hour_230808_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230808_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230808_bus")

```


```{r run_for_all_modes_all_of_Victoria_230809, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_230809_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230809_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230809_tram")

si_by_area_and_hour_230809_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230809_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230809_rail")

si_by_area_and_hour_230809_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230809_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230809_bus")

```



```{r run_for_all_modes_all_of_Victoria_230810, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_230810_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230810_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230810_tram")

si_by_area_and_hour_230810_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230810_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230810_rail")

si_by_area_and_hour_230810_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230810_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230810_bus")

```


```{r run_for_all_modes_all_of_Victoria_230811, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_230811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230811_tram")

si_by_area_and_hour_230811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230811_rail")

si_by_area_and_hour_230811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230811_bus")

```

```{r run_for_all_modes_all_of_Victoria_230812, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_230804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_230804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_230804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_230812_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2023-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230812_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230812_tram")

si_by_area_and_hour_230812_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2023-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230812_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230812_rail")

si_by_area_and_hour_230812_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2023-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_230812_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_230812_bus")

```


```{r fix_ptv_data_Victoria_220804, eval = FALSE, echo = FALSE}


ptv_220804 <- tidytransit::read_gtfs("data/ptv_220804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_220804_duplicated_stops <- tabyl(ptv_220804$stops$stop_id) %>% filter (n>1)
names(ptv_220804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_220804_duplicated_stops <- left_join(ptv_220804_duplicated_stops, ptv_220804$stops)

##discard duplicates
ptv_220804$stops <- ptv_220804$stops[!duplicated(ptv_220804$stops$stop_id),]

## Write gtfs back to file
ptv_220804 <- as_tidygtfs(ptv_220804)
tidytransit::write_gtfs(ptv_220804, "data/ptv_220804/gtfs_duplicate_stops_removed.zip")

```

```{r fix_ptv_data_Victoria_210805, eval = FALSE, echo = FALSE}


ptv_210805 <- tidytransit::read_gtfs("data/ptv_210805/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_210805_duplicated_stops <- tabyl(ptv_210805$stops$stop_id) %>% filter (n>1)
names(ptv_210805_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_210805_duplicated_stops <- left_join(ptv_210805_duplicated_stops, ptv_210805$stops)

##discard duplicates
ptv_210805$stops <- ptv_210805$stops[!duplicated(ptv_210805$stops$stop_id),]

## Write gtfs back to file
ptv_210805 <- as_tidygtfs(ptv_210805)
tidytransit::write_gtfs(ptv_210805, "data/ptv_210805/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_210810, eval = FALSE, echo = FALSE}
list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210810")

si_by_area_and_hour_210810_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210810_tram")

si_by_area_and_hour_210810_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210810_rail")

si_by_area_and_hour_210810_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210810_bus")

```


```{r run_for_all_modes_Victoria_210811, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210811_tram")

si_by_area_and_hour_210811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210811_rail")

si_by_area_and_hour_210811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210811_bus")

```


```{r run_for_all_modes_Victoria_210812, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210812_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210812_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210812_tram")

si_by_area_and_hour_210812_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210812_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210812_rail")

si_by_area_and_hour_210812_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210812_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210812_bus")

```


```{r run_for_all_modes_Victoria_210813, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210813_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210813_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210813_tram")

si_by_area_and_hour_210813_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210813_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210813_rail")

si_by_area_and_hour_210813_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210813_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210813_bus")

```


```{r run_for_all_modes_Victoria_210814, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210814_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210814_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210814_tram")

si_by_area_and_hour_210814_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210814_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210814_rail")

si_by_area_and_hour_210814_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210814_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210814_bus")

```


```{r run_for_all_modes_Victoria_210815, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210815_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210815_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210815_tram")

si_by_area_and_hour_210815_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210815_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210815_rail")

si_by_area_and_hour_210815_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210815_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210815_bus")

```


```{r run_for_all_modes_Victoria_210816, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_210805/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_210805_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_210816_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2021-08-16",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210816_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210816_tram")

si_by_area_and_hour_210816_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2021-08-16",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210816_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210816_rail")

si_by_area_and_hour_210816_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2021-08-16",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210816_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_210816_bus")

```



```{r fix_ptv_data_Victoria_200729, eval = FALSE, echo = FALSE}


ptv_200729 <- tidytransit::read_gtfs("data/ptv_200729/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_200729_duplicated_stops <- tabyl(ptv_200729$stops$stop_id) %>% filter (n>1)
names(ptv_200729_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_200729_duplicated_stops <- left_join(ptv_200729_duplicated_stops, ptv_200729$stops)

##discard duplicates
ptv_200729$stops <- ptv_200729$stops[!duplicated(ptv_200729$stops$stop_id),]

## Write gtfs back to file
ptv_200729 <- as_tidygtfs(ptv_200729)
tidytransit::write_gtfs(ptv_200729, "data/ptv_200729/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_200729_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_200729/gtfs_duplicate_stops_removed.zip")

```

```{r run_for_all_modes_Victoria_200811, eval = FALSE, echo = FALSE}

list_gtfs = ptv_200729_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_200811 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811, "results/Greater_Melbourne/si_by_SA12021area_and_hour_200811")

si_by_area_and_hour_200811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_200811_tram")

si_by_area_and_hour_200811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_200811_rail")

si_by_area_and_hour_200811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2020-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_200811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_200811_bus")

```

```{r fix_ptv_data_Victoria_190802, eval = FALSE, echo = FALSE}
ptv_190802 <- tidytransit::read_gtfs("data/ptv_190802/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_190802_duplicated_stops <- tabyl(ptv_190802$stops$stop_id) %>% filter (n>1)
names(ptv_190802_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_190802_duplicated_stops <- left_join(ptv_190802_duplicated_stops, ptv_190802$stops)

##discard duplicates
ptv_190802$stops <- ptv_190802$stops[!duplicated(ptv_190802$stops$stop_id),]

## Write gtfs back to file
ptv_190802 <- as_tidygtfs(ptv_190802)
tidytransit::write_gtfs(ptv_190802, "data/ptv_190802/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_190802_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_190802/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_190813, eval = FALSE, echo = FALSE}

list_gtfs = ptv_190802_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_190813 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813, "results/Greater_Melbourne/si_by_SA12021area_and_hour_190813")

si_by_area_and_hour_190813_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_190813_tram")

si_by_area_and_hour_190813_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_190813_rail")

si_by_area_and_hour_190813_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2019-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_190813_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_190813_bus")

```

```{r fix_ptv_data_Victoria_180803, eval = FALSE, echo = FALSE}


ptv_180803 <- tidytransit::read_gtfs("data/ptv_180803/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_180803_duplicated_stops <- tabyl(ptv_180803$stops$stop_id) %>% filter (n>1)
names(ptv_180803_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_180803_duplicated_stops <- left_join(ptv_180803_duplicated_stops, ptv_180803$stops)

##discard duplicates
ptv_180803$stops <- ptv_180803$stops[!duplicated(ptv_180803$stops$stop_id),]

## Write gtfs back to file
ptv_180803 <- as_tidygtfs(ptv_180803)
tidytransit::write_gtfs(ptv_180803, "data/ptv_180803/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_180803_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_180803/gtfs_duplicate_stops_removed.zip")


```


```{r run_for_all_modes_Victoria_180814, eval = FALSE, echo = FALSE}


list_gtfs = ptv_180803_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)
si_by_area_and_hour_180814 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814, "results/Greater_Melbourne/si_by_SA12021area_and_hour_180814")

si_by_area_and_hour_180814_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_180814_tram")

si_by_area_and_hour_180814_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_180814_rail")

si_by_area_and_hour_180814_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2018-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_180814_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_180814_bus")

```

```{r fix_ptv_data_Victoria_170804, eval = FALSE, echo = FALSE}


ptv_170804 <- tidytransit::read_gtfs("data/ptv_170804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_170804_duplicated_stops <- tabyl(ptv_170804$stops$stop_id) %>% filter (n>1)
names(ptv_170804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_170804_duplicated_stops <- left_join(ptv_170804_duplicated_stops, ptv_170804$stops)

##discard duplicates
ptv_170804$stops <- ptv_170804$stops[!duplicated(ptv_170804$stops$stop_id),]

## Write gtfs back to file
ptv_170804 <- as_tidygtfs(ptv_170804)
tidytransit::write_gtfs(ptv_170804, "data/ptv_170804/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_170804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_170804/gtfs_duplicate_stops_removed.zip")

```


```{r run_for_all_modes_Victoria_170808, eval = FALSE, echo = FALSE}


list_gtfs = ptv_170804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_170808 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808, "results/Greater_Melbourne/si_by_SA12021area_and_hour_170808")

si_by_area_and_hour_170808_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_170808_tram")

si_by_area_and_hour_170808_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_170808_rail")

si_by_area_and_hour_170808_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2017-08-08",
  verbose = TRUE)

write.csv(si_by_area_and_hour_170808_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_170808_bus")

```

```{r fix_ptv_data_Victoria_160804, eval = FALSE, echo = FALSE}
 

ptv_160804 <- tidytransit::read_gtfs("data/ptv_160804/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_160804_duplicated_stops <- tabyl(ptv_160804$stops$stop_id) %>% filter (n>1)
names(ptv_160804_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_160804_duplicated_stops <- left_join(ptv_160804_duplicated_stops, ptv_160804$stops)

##discard duplicates
ptv_160804$stops <- ptv_160804$stops[!duplicated(ptv_160804$stops$stop_id),]

## Write gtfs back to file
ptv_160804 <- as_tidygtfs(ptv_160804)
tidytransit::write_gtfs(ptv_160804, "data/ptv_160804/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

```

```{r run_for_all_modes_Victoria_160809, eval = FALSE, echo = FALSE}
list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160809")

si_by_area_and_hour_160809_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160809_tram")

si_by_area_and_hour_160809_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160809_rail")

si_by_area_and_hour_160809_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160809_bus")

```


```{r run_for_all_modes_Victoria_160810, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160810_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160810_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160810_tram")

si_by_area_and_hour_160810_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160810_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160810_rail")

si_by_area_and_hour_160810_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160810_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160810_bus")

```


```{r run_for_all_modes_Victoria_160811, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160811_tram")

si_by_area_and_hour_160811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160811_rail")

si_by_area_and_hour_160811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160811_bus")

```


```{r run_for_all_modes_Victoria_160812, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Victoria") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()


list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160812_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160812_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160812_tram")

si_by_area_and_hour_160812_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160812_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160812_rail")

si_by_area_and_hour_160812_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-12",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160812_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160812_bus")

```


```{r run_for_all_modes_Victoria_160813, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160813_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160813_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160813_tram")

si_by_area_and_hour_160813_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160813_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160813_rail")

si_by_area_and_hour_160813_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-13",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160813_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160813_bus")

```


```{r run_for_all_modes_Victoria_160814, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160814_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160814_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160814_tram")

si_by_area_and_hour_160814_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160814_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160814_rail")

si_by_area_and_hour_160814_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-14",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160814_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160814_bus")

```


```{r run_for_all_modes_Victoria_160815, eval = FALSE, echo = FALSE}
## convert to list of tidygtfs objects
ptv_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_160804/gtfs_duplicate_stops_removed.zip")

list_gtfs = ptv_160804_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_160815_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2016-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160815_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160815_tram")

si_by_area_and_hour_160815_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2016-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160815_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160815_rail")

si_by_area_and_hour_160815_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2016-08-15",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160815_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_160815_bus")

```


```{r fix_ptv_data_Victoria_150729, eval = FALSE, echo = FALSE}


ptv_150729 <- tidytransit::read_gtfs("data/ptv_150729/gtfs.zip")
# This results in "Warning: Duplicated ids found in: stops The returned object is not a tidygtfs object, you can use as_tidygtfs() after fixing the issue."

#So, remove the duplicated stops 
#identify duplicate stops
ptv_150729_duplicated_stops <- tabyl(ptv_150729$stops$stop_id) %>% filter (n>1)
names(ptv_150729_duplicated_stops) <- c("stop_id", "n", "percent")
ptv_150729_duplicated_stops <- left_join(ptv_150729_duplicated_stops, ptv_150729$stops)

##discard duplicates
ptv_150729$stops <- ptv_150729$stops[!duplicated(ptv_150729$stops$stop_id),]

## Write gtfs back to file
ptv_150729 <- as_tidygtfs(ptv_150729)
tidytransit::write_gtfs(ptv_150729, "data/ptv_150729/gtfs_duplicate_stops_removed.zip")

## convert to list of tidygtfs objects
ptv_150729_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ptv_150729/gtfs_duplicate_stops_removed.zip")


```

```{r run_for_all_modes_Victoria_150811, eval = FALSE, echo = FALSE}

list_gtfs = ptv_150729_list_gtfs

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

si_by_area_and_hour_150811 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811, "results/Greater_Melbourne/si_by_SA12021area_and_hour_150811")

si_by_area_and_hour_150811_tram <- hourly(
  list_gtfs = list_gtfs[1], 
  stops_in_or_near_areas = stops_in_or_near_areas[1], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_tram, "results/Greater_Melbourne/si_by_SA12021area_and_hour_150811_tram")

si_by_area_and_hour_150811_rail <- hourly(
  list_gtfs = list_gtfs[2], 
  stops_in_or_near_areas = stops_in_or_near_areas[2], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_rail, "results/Greater_Melbourne/si_by_SA12021area_and_hour_150811_rail")

si_by_area_and_hour_150811_bus <- hourly(
  list_gtfs = list_gtfs[3], 
  stops_in_or_near_areas = stops_in_or_near_areas[3], 
  date_ymd = "2015-08-11",
  verbose = TRUE)

write.csv(si_by_area_and_hour_150811_bus, "results/Greater_Melbourne/si_by_SA12021area_and_hour_150811_bus")

```


NEED TO CHECK THAT A WHOLE WEEK OF DATA IS ANALYSED FOR ALL PLACES

### Australian Capital Territory 


```{r run_for_all_modes_ACT_bus_2016_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
act_160803_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/act_160803/gtfs.zip")

list_gtfs = act_160803_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Australian Capital Territory") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/Action_buses/si_by_SA12021area_and_hour_160809")


```


```{r run_for_all_modes_ACT_bus_2021_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
act_210701_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/act_210701/gtfs.zip")

list_gtfs = act_210701_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Australian Capital Territory") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/Action_buses/si_by_SA12021area_and_hour_210810")


```



```{r run_for_all_modes_ACT_LRT_2021_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
clr_210709_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/clr_210709/gtfs.zip")

list_gtfs = clr_2107091_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Australian Capital Territory") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/Canberra_Light_Rail/si_by_SA12021area_and_hour_210810")


```



### Adelaide



```{r run_for_all_modes_Adelaide_2016_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
ade_160802_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ade_160802/gtfs.zip")

list_gtfs = ade_160802_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "South Australia") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/Adelaide/si_by_SA12021area_and_hour_160809")


```


```{r run_for_all_modes_Adelaide_2021_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
ade_210716_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/ade_210716/gtfs.zip")

list_gtfs = ade_210716_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "South Australia") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/Adelaide/si_by_SA12021area_and_hour_210810")


```




### Metro Tasmania Burnie



```{r run_for_all_modes_Tassie_Burnie_2016_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
metro_tas_burnie_160620_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/metro_tas_burnie_160620/gtfs.zip")

list_gtfs = metro_tas_burnie_160620_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Tasmania") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/metro_tas_burnie/si_by_SA12021area_and_hour_160809")


```


```{r run_for_all_modes_Tassie_Burnie_2021_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
metro_tas_burnie_210601_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/metro_tas_burnie_210601/gtfs.zip")

list_gtfs = metro_tas_burnie_210601_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Tasmania") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/metro_tas_burnie/si_by_SA12021area_and_hour_210810")


```





### Metro Tasmania Hobart



```{r run_for_all_modes_Tassie_Hobart_2016_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
metro_tas_hobart_160713_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/metro_tas_hobart_160713/gtfs.zip")

list_gtfs = metro_tas_burnie_160620_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Tasmania") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/metro_tas_hobart/si_by_SA12021area_and_hour_160809")


```


```{r run_for_all_modes_Tassie_Hobart_2021_census_day, eval = FALSE, echo = FALSE}

## convert to list of tidygtfs objects
metro_tas_hobart_210726_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/metro_tas_hobart_210726/gtfs.zip")

list_gtfs = metro_tas_hobart_210726_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Tasmania") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/metro_tas_hobart/si_by_SA12021area_and_hour_210810")


```




### Metro Tasmania Launceston



```{r run_for_all_modes_Tassie_Launceston_2016_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
metro_tas_launceston_160620_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/metro_tas_launceston_160620/gtfs.zip")

list_gtfs = metro_tas_launceston_160620_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Tasmania") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/metro_tas_launceston_160620/si_by_SA12021area_and_hour_160809")


```


```{r run_for_all_modes_Tassie_Launceston_2021_census_day, eval = FALSE, echo = FALSE}

## convert to list of tidygtfs objects
metro_tas_launceston_210726_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/metro_tas_launceston_210726/gtfs.zip")

list_gtfs = metro_tas_launceston_210726_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Tasmania") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/metro_tas_launceston/si_by_SA12021area_and_hour_210810")


```




### Translink South East Queensland



```{r run_for_all_modes_SEQ_2016_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
translink_seq_160808_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/translink_seq_160808/gtfs.zip")

list_gtfs = translink_seq_160808_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Queensland") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/translink_seq/si_by_SA12021area_and_hour_160809")


```


```{r run_for_all_modes_SEQ_2021_census_day, eval = FALSE, echo = FALSE}

## convert to list of tidygtfs objects
translink_seq_210806_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/metro_tas_launceston_210726/gtfs.zip")

list_gtfs = translink_seq_210806_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Queensland") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/translink_seq_210806/si_by_SA12021area_and_hour_210810")


```




### Transperth



```{r run_for_all_modes_Perth_2016_census_day, eval = FALSE, echo = FALSE}



## convert to list of tidygtfs objects
transperth_160804_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/transperth_160804/gtfs.zip")

list_gtfs = transperth_160804_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Queensland") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_160809 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2016-08-09",
  verbose = TRUE)

write.csv(si_by_area_and_hour_160809, "results/transperth/si_by_SA12021area_and_hour_160809")


```


```{r run_for_all_modes_transperth_2021_census_day, eval = FALSE, echo = FALSE}

## convert to list of tidygtfs objects
transperth_210805_list_gtfs <- gtfssupplyindex::gtfs_by_route_type("data/transperth_210805/gtfs.zip")

list_gtfs = transperth_210805_list_gtfs

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% 
                                              filter(state_name_2021 == "Queensland") %>%
                                              select(sa1_code_2021),  
                                            area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour_210810 <- hourly(
  list_gtfs = list_gtfs, 
  stops_in_or_near_areas = stops_in_or_near_areas, 
  date_ymd = "2021-08-10",
  verbose = TRUE)

write.csv(si_by_area_and_hour_210810, "results/transperth_210805/si_by_SA12021area_and_hour_210810")


```



## Measuring social disadvantage
This study adopts the same approach to measuring social disadvantage 
as @currie2010identifying, 
using: the Australian Bureau of Statistics Index of Relative Socio-Economic
Advantage/Disadvantage (IRSAD); and
a transport needs index, which included the same need indicators and weightings 
as used in @currie2010identifying^[Indicators: Adults without cars (weighting 0.19); accessibility (distance to Central Buisness District, 0.15); persons aged over 60 years (0.14); persons on a disability pension (0.12); low income families (0.10); adults not in the labour force (0.09); students (0.09); and persons aged 5-9 years (0.12). Data was extracted from the 2021 census, including the disability pension data which is now available through the ABS rather than Centrelink. A income of $799 or lower per week was adopted as the  threshold for low income households, based on updating the $499 figure used in @currie2010identifying to account for inflation, using the Reserve Bank of Australia's online inflation calculator. Note also that the 2021 census reported low-income families rather than households, as was used in @currie2010identifying.]

```{r read_ABS_data, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.fullwidth = TRUE, fig.cap="SI scores by SA3, census day 2016 and 2021"}

#read IRSAD 2021 and remove non-data rows
sa1_irsad_2021 <- read_excel("data/Statistical Area Level 1, Indexes, SEIFA 2021.xlsx", 
    sheet = "Table 3", skip = 5)
sa1_irsad_2021 <- sa1_irsad_2021 %>% filter(row_number() <= n()-3)
sa1_irsad_2021 <- sa1_irsad_2021 %>% 
  clean_names()

#read students 2021 and remove non-data rows
sa1_students_2021 <- read_csv("data/sa1_students.csv", 
    skip = 8)
sa1_students_2021 <- sa1_students_2021[-1,]
sa1_students_2021 <- sa1_students_2021 %>% filter(row_number() <= n()-5)

#read not in labour force in 2021 and remove non-data rows
#this dataset contains a single 'wafer', 
# being those people not in the labour force, separated by age and sa1
sa1_not_in_labour_force_2021 <- read_csv("data/sa1_not_in_labour_force_2021.csv", 
    skip = 10)
sa1_not_in_labour_force_2021 <- sa1_not_in_labour_force_2021[-1,]
#not_in_labour_force csv from ABS repeats the entire dataset, hence only read in first set
sa1_not_in_labour_force_2021 <- sa1_not_in_labour_force_2021 %>% filter(row_number() <= n()-61844)


#calculate number of adults not in labour force (ie 18+)
sa1_not_in_labour_force_2021$adult_not_labour_force <- rowSums (sa1_not_in_labour_force_2021[,20:117])
  



#read no car in 2021 and remove non-data rows
#this dataset contains a single 'wafer', 
# being those people living in a household with no car, separated by age and sa1
sa1_no_car_2021 <- read_csv("data/sa1_no_car_2021.csv", 
    skip = 8)
sa1_no_car_2021 <- sa1_no_car_2021[-1,]
sa1_no_car_2021 <- sa1_no_car_2021 %>% filter(row_number() <= n()-5)
#calculate number of adults with no car (ie 18+)
sa1_no_car_2021$adult_no_car <- rowSums(sa1_no_car_2021[,20:117])


#read low income in 2021 and remove non-data rows
sa1_low_income_2021 <- read_csv("data/sa1_low_income.csv", 
    skip = 8)
sa1_low_income_2021 <- sa1_low_income_2021[-1,]
sa1_low_income_2021 <- sa1_low_income_2021 %>% filter(row_number() <= n()-5)

#read disability support pension in 2021 and remove non-data rows
sa1_disability_support_pension_2021 <- read_csv("data/sa1_disability_2021.csv", 
    skip = 8)
sa1_disability_support_pension_2021 <- sa1_disability_support_pension_2021[-1,]
sa1_disability_support_pension_2021 <- sa1_disability_support_pension_2021 %>% filter(row_number() <= n()-5)




#read age in 2021 and remove non-data rows
sa1_age_2021 <- read_csv("data/sa1_age.csv", 
    skip = 8)
sa1_age_2021 <- sa1_age_2021[-1,]
sa1_age_2021 <- sa1_age_2021 %>% filter(row_number() <= n()-5)

#calculate number of people over 60.
sa1_age_2021$over_60 <- rowSums(sa1_age_2021[,63:117])

#calculate number of persons 5 to 9 years old.
sa1_age_2021$persons_5_to_9 <- rowSums(sa1_age_2021[,7:11]) 
#move age-related indicators into social indicators table. 
social_2021_sa1 <- sa1_age_2021 %>% 
  select(`AGEP Age`, over_60, persons_5_to_9)
names(social_2021_sa1) <- c("sa1_code_2021", "over_60", "five_to_nine")

#join Adults without Cars
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_no_car_2021 %>% 
                               select("AGEP Age", "adult_no_car"), 
                             by = join_by( "sa1_code_2021" == "AGEP Age"))

#join disability pension 
sa1_disability_support_pension_2021 <-  sa1_disability_support_pension_2021 %>% 
  clean_names()
  
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_disability_support_pension_2021 %>% 
                               select(
                                 "igap_main_type_of_personal_government_benefit_payment_administrative_data", 
                                      "disability_support_pension"),
                             by = join_by(
                               "sa1_code_2021" == "igap_main_type_of_personal_government_benefit_payment_administrative_data"))



#join low income households
sa1_low_income_2021$low_income_families <- rowSums(sa1_low_income_2021[,2:9])
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_low_income_2021 %>% 
                               select("FINASF Total Family Income as Stated (weekly)", "low_income_families"), 
                             by = join_by( "sa1_code_2021" == "FINASF Total Family Income as Stated (weekly)"))


#join adults not in labour force
social_2021_sa1 <- full_join(social_2021_sa1 %>% na.omit(), 
                             sa1_not_in_labour_force_2021 %>% 
                               select("AGEP Age", "adult_not_labour_force") %>%
                               na.omit(), 
                             by = join_by("sa1_code_2021" == "AGEP Age"))

#join students
sa1_students_2021$students <- sa1_students_2021$Total
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_students_2021 %>% 
                               select("STUP Full-Time/Part-Time Student Status", "students"), 
                             by = join_by( "sa1_code_2021" == "STUP Full-Time/Part-Time Student Status"))

#join IRSAD scores
sa1_irsad_2021$x2021_statistical_area_level_1_sa1 <- sa1_irsad_2021$x2021_statistical_area_level_1_sa1 %>% 
  as.character()
names(sa1_irsad_2021) <- c("sa1_code_2021", 
                           "usual_resident_population",
                           "IRSAD", 
                           "x4", 
                           "rank_in_australia", 
                           "decile_in_australia",
                           "percentile_in_australia", 
                           "x8", 
                           "state", 
                           "rank_in_state",
                           "decile_in_state",
                           "percentile_in_state")

social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_irsad_2021 %>% 
                               select("sa1_code_2021", "IRSAD"))


#join SA1 enumerated population
social_2021_sa1 <- full_join(social_2021_sa1, 
                             sa1_age_2021 %>% 
                               select("AGEP Age", "Total"), 
                             by = join_by("sa1_code_2021" == "AGEP Age"))

names(social_2021_sa1) <- c("sa1_code_2021", 
                            "over_60", "age_five_to_nine", 
                            "adult_no_car", 
                            "disability_support_pension",
                            "low_income_families",
                            "adult_not_labour_force",
                            "students", 
                            "IRSAD", 
                            "population")

##Rescaling to 0-100 and adding the accessibility indicator needs to be done on a areas_of_interest by areas_of_interest bias, as which areas are included will matter. 

```

This study also adopts the same approach as @currie2010identifying 
for deriving a single combined indicator of social need, based combining the ABS' IRSAD and the transport needs index^[See @currie2010identifying, page 34]. However, @currie2010identifying included indexes weighted for both total population within each area of interest, and for relative need based on the proportion of the population within each social need component group. Currently, however, ABS census data is not available to a level such that the number of people in a SA1 zone who are within at least one social need component group can be identified. As such, only a total need IRSAD index and a total transport need index are computed in this study for each SA1 zone, which were then added and standardised as per the @currie2010identifying approach.  


# Results
## Code structure and functionality


Developed code is available and documented on github (see @gtfssupplyindex_github). 
The structure of the package, 
functions developed, 
and data tables are shown in Figure \@ref(fig:SI_ERD), 
which indicates
how the package takes input from three files: 
a gtfs feed (gtfs.zip); 
a sf object 
describing the geometry 
of the areas of interest 
for which the SI is to be calculated; and 
a csv file 
(included in the package) 
defining the buffer zone distances
for each route type. 
The ultimate output 
is a si_by_area_and_hour table 
(Figure \@ref(fig:SI_ERD), bottom-right), 
which reports the SI score for each hour 
of a day specified by the user. 


```{r SI_ERD, crop = TRUE, fig.cap = "Entity Relationship Diagram (ERD) showing the data structure and functions related to the gtfssupplyindex package", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
knitr::include_graphics("graphics/SI_data_structure.png")

```

The various functions 
included in the package 
and their output 
are explained in the following, 
using the Mornington Peninsula GTFS 
as a worked example^[This paper itself 
was prepared in Rmarkdown and is available at https://github.com/James-Reynolds/gtfssupplyindex_main_paper. 
Code snippets used to produce the outputs 
of the worked example can be viewed there.]
Individual steps are as follows:

(1) The GTFS data is loaded using  
the gtfs_by_route_type function 
which also splits it into a list (by route_type) of tidygtfs objects, 
using the filter_by_route_type function from the gtfstools package [@filter_GTFS_by_mode].

```{r load_mornington_GTFS data, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

```

(2) Geometry information about the areas of interest is loaded by the load_areas_of_interest
function using the sf package [@R-sf]. 
The resultant areas_of_interest table 

(3) The walking distance threshold assigned to each route_type (mode)
is then loaded, using the load_buffer_zone function.

```{r load_ABS data, echo = FALSE, error = FALSE, include = FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}

suppressWarnings({
areas_of_interest <- load_areas_of_interest(areas_of_interest = sf::st_read(system.file(
  "extdata",
  "mornington_sa12021.geojson", 
  package = "gtfssupplyindex", 
  mustWork = TRUE)), 
  area_id_field = "sa1_code_2021")
})

#head(areas_of_interest) %>% kable(caption = "First 6 entries in areas of interest table")
```

```{r load_buffer_distance_data, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
buffer_distance <- gtfssupplyindex:::load_buffer_zones()
#head(buffer_distance) %>% kable(caption = "First six entries in buffer distance definitions")
```

(4) Stops within the catchment walking distance of each area_of_interest are then identified using the stops_in_walk_dist function. Figure \@ref(fig:calculate_stop_in_or_near_areas_verbose) shows how this functions identifies the SA1 areas within the 800 metre catchment of all three of the Mornington stations.


```{r calculate_stop_in_or_near_areas_verbose, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%', fig.keep = "first", crop = TRUE, fig.cap= "Step 3, stop catchments for the Mornington Penninsula Tourist Railway, showing intersections with SA1 zones"}
stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355, 
  verbose = TRUE
)

```

(5) SI scores are calculated for a given time period using the si_calc function, 
which first identifies the 
number of arrivals in a given time period 
at each stop 
using code adapted from an article included in the tidytransit package
[@tidytransit_departure_timetable]. 
The area terms of the SI value are calculated,
with the si_total and hourly functions providing aggregation by area or by area and hour.
Figure \@ref(fig:SI_mornington_20181230_output) shows the hourly output for the Mornington Peninsula Railway, 
adopting December 30, 2018 as the date of analysis. 

```{r arrivals_mornington_20181230, echo = FALSE, eval=FALSE, warning=FALSE, message=FALSE, cache=TRUE}

stop_ids <- list_gtfs[[1]]$stops %>%
 dplyr::select(stop_id)

arrivals_by_stop_id <- gtfssupplyindex::arrivals(
 gtfs = list_gtfs[[1]],
 stop_ids = stop_ids,
 date_ymd = "2018-12-30",
 start_hms = lubridate::hms("10:30:00"),
 end_hms = lubridate::hms("16:00:00")
)

#arrivals_by_stop_id %>% kable(caption = "Arrivals at each stop for Sunday December 30th 2018, Mornington Peninsula tourist railway.")

```
<!--- This matches the number of trips shown in the Mornington Railway GTFS feed, being 4 in each direction^[https://transitfeeds.com/p/mornington-railway/806/latest/stop/1388695887/20181230]. 

```{r SI_Mornington_arrivals, fig.margin = FALSE, crop = TRUE, fig.cap = "Arrivals at Mornington Station (stop id 1388695887) for 30/12/2018", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, out.width='100%'}
knitr::include_graphics("graphics/1388695887_inbound.png")

```

All the inputs to calculate the si are now available. Hence, the SI.calc function can be run, resulting in the si_by_route_type list (by route_type) of tables showing the area_id corresponding SI values

```{r SI_mornington_20181230, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}
####-----first load all the inputs

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

areas_of_interest <- load_areas_of_interest(absmapsdata::sa22021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa2_code_2021),  area_id_field = "sa2_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)

####----run SI.calc function to build si_by_mode_and_time list (by route_type) of tables

si_by_route_type <- si_calc(
    list_gtfs = list_gtfs,
    stops_in_or_near_areas = stops_in_or_near_areas, 
    date_ymd = lubridate::ymd("2018-12-30"), 
    start_hms = lubridate::hms("10:30:00"),
    end_hms = lubridate::hms("16:00:00"),
    verbose = TRUE)

si_by_route_type %>% kable(caption = "SI values for Mornington Penninsula Railway services on 30/12/2018 (full day)")

```

The si_total function aggregates the si_by_route_type tables so that values are no longer separated by mode. Although in the case of the Mornington Penninsula Railway there is only one route_type.  

Finally, the hourly function runs the si_calc and si_total functions for every hour in a single day. It outputs a table showing the SI scores for each area for each hour of the day^[Across the service span]. The below table shows this output, together with row and column totals.  

```{r SI_hourly_mornington_20181230, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE}

si_by_area_and_hour_wider <- hourly(list_gtfs, stops_in_or_near_areas, "2018-12-30")

si_by_area_and_hour_wider %>% adorn_totals(where = c("row", "col")) %>% kable(caption = "Mornington Penninsula Tourist Railway hourly SI values for December 30, 2018, for SA1 zones")

```
--->

```{r SI_mornington_20181230_output, echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, crop = TRUE, fig.cap = "Mornington Penninsula Tourist Railway hourly SI values for December 30, 2018"}
####-----first load all the inputs

#load the revised mornington GTFS data
list_gtfs = gtfssupplyindex:::gtfs_by_route_type(system.file(
  "extdata/mornington180109",
  "gtfs.zip", 
  package = "gtfssupplyindex", 
  mustWork = TRUE))

areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021),  area_id_field = "sa1_code_2021")

buffer_distance <- gtfssupplyindex:::load_buffer_zones()

stops_in_or_near_areas <- gtfssupplyindex:::stops_in_walk_dist(
  list_gtfs = list_gtfs, 
  areas_of_interest = areas_of_interest,
  EPSG_for_transform = 28355,
  verbose = FALSE
)


si_by_area_and_hour <- hourly(list_gtfs, stops_in_or_near_areas, "2018-12-30")


si_by_area_and_hour_wider <- pivot_wider(si_by_area_and_hour, names_from = hour_starting, values_from = SI)

#si_by_area_and_hour_wider %>% 
#  head() %>%
#  adorn_rounding() %>%
#  kable(caption = "Mornington Peninsula Tourist Railway hourly SI values for December 30, 2018")

map_areas_of_interest <- load_areas_of_interest(absmapsdata::sa12021 %>% filter(sa3_name_2021 == "Mornington Peninsula") %>% select(sa1_code_2021),  area_id_field = "sa1_code_2021")

#Join SI to map data
map_si_by_area_and_hour <- merge(map_areas_of_interest, si_by_area_and_hour)

map_si_by_area_and_hour <- na.omit(map_si_by_area_and_hour)

ggplot() + 
  geom_sf(data=map_si_by_area_and_hour,
          aes(fill = SI)) +
            facet_wrap(vars(hour_starting)) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
  )



```



## Greater Melbourne 

### SI scores
```{r Greater_Melbourne_2016_2021, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="SI scores, census day 2021"}


###2021
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_210810 <- read.csv("results/Greater_Melbourne/si_by_SA12021area_and_hour_210810")
si_by_area_and_hour_210810 <- si_by_area_and_hour_210810[,2:4]
si_by_area_and_hour_210810$area_id <- as.character(si_by_area_and_hour_210810$area_id)

si_by_area_210810 <- si_by_area_and_hour_210810 %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))

##Join to absmaps so as to identify (and enumerate as zero) those SA1 zones 
# that have no SI score
si_by_area_210810 <- full_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021) %>%
    st_drop_geometry(),
  si_by_area_210810, 
  by = join_by(sa1_code_2021  == area_id))
si_by_area_210810[is.na(si_by_area_210810)] <- 0

names(si_by_area_210810) <- c("area_id", "SI")
si_by_area_210810$Year <- 2021

## Function to define thresholds and return Very High, High etc. as per 
# Currie2010
set_thresholds <-function(sa_by_area_dataframe){ 
## Define Very High, High etc thresholds
cuts <- sa_by_area_dataframe %>% 
  filter(SI != 0) %>% 
  select(SI) %>% 
  unlist()  %>% 
  as.vector() %>% 
  quantileCut(6)

cuts <- sapply(str_extract_all(cuts, "-?[0-9.]+"), function(x) max(as.numeric(x))) %>%
  unique() %>% 
  as.numeric() %>% 
  sort()
  
 sa_by_area_dataframe$SI_binned <- ifelse(
   sa_by_area_dataframe$SI == 0, "Zero", ifelse(
     sa_by_area_dataframe$SI < cuts[1], "Very low", ifelse(
       sa_by_area_dataframe$SI < cuts[2], "Low", ifelse(
         sa_by_area_dataframe$SI < cuts[3], "Below average", ifelse(
           sa_by_area_dataframe$SI < cuts[4], "Above average", ifelse(
             sa_by_area_dataframe$SI < cuts[5], "High", ifelse(
               sa_by_area_dataframe$SI >= cuts[5], "Very high", NA)
             )
           )
         )
       )
     )
   ) 

sa_by_area_dataframe$SI_binned <- factor(sa_by_area_dataframe$SI_binned, 
                                         levels = c(
                                           "Zero", 
                                           "Very low", 
                                           "Low", 
                                           "Below average",
                                           "Above average", 
                                           "High", 
                                           "Very high"
                                         ))
si_by_area_dataframe_and_cuts_dataframe <- list(
  sa_by_area_dataframe,
  cuts
  )

return(si_by_area_dataframe_and_cuts_dataframe)
}


si_by_area_210810_thresholds <- set_thresholds(sa_by_area_dataframe = si_by_area_210810)
si_by_area_210810 <- si_by_area_210810_thresholds[[1]]









###2016
###Load results from CSV (Precalculated above) and make first column character
si_by_area_and_hour_160809 <- read.csv("results/Greater_Melbourne/si_by_SA12021area_and_hour_160809")
si_by_area_and_hour_160809 <- si_by_area_and_hour_160809[,2:4]
si_by_area_and_hour_160809$area_id <- as.character(si_by_area_and_hour_160809$area_id)

si_by_area_160809 <- si_by_area_and_hour_160809 %>% 
           group_by(area_id) %>%    
           summarize(SI = sum(SI))


##Join to absmaps so as to identify (and enumerate as zero) those SA1 zones 
# that have no SI score
si_by_area_160809  <- full_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021) %>%
    st_drop_geometry(),
  si_by_area_160809 , 
  by = join_by(sa1_code_2021  == area_id))
si_by_area_160809[is.na(si_by_area_160809)] <- 0

names(si_by_area_160809) <- c("area_id", "SI")

si_by_area_160809$Year <- 2016

si_by_area_160809_thresholds <- set_thresholds(sa_by_area_dataframe = si_by_area_160809)
si_by_area_160809 <- si_by_area_160809_thresholds[[1]]

```


```{r Greater_Melbourne_2016_2021_comparison, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="SI scores, census day 2021"}
si_by_area_2016_2021 <- add_row(si_by_area_160809, si_by_area_210810)
names(si_by_area_2016_2021) <- c("sa1_code_2021", "SI", "Year", "SI_binned")

si_by_area_2016_2021  <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021),
  si_by_area_2016_2021)

plot_2016_2021_comparison <- ggplot()+ 
  geom_sf(data=si_by_area_2016_2021 %>% na.omit(),
          aes(fill = SI_binned), colour=NA) +
  facet_wrap(vars(Year), nrow = 1) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(),
        legend.position="bottom") + #remove y axis ticks
  scale_fill_manual(values = c("#FFFFFF", "#F9D8B1", "#F7C387", "#F29C33", "#5DB000", "#53A212", "#407F0B")) #remove y axis ticks

plot_2016_2021_comparison



```

#PICK UP FROM HERE
NEED TO ADD SCALE, NORTH ARROW AND INNER, MIDDLE, OUTER boundaries.  CONSIDER ADDING TRAIN LINES AND 2006 GREATER MELBOURNE BOUNDARY


Figure \ref{fig:Greater_Melbourne_2016_2021} shows SI values on census day for Greater Melbourne in 2016 and 2021. Comparison to Figure \ref{fig:Currie_map_SI} indicates that:

- The Greater Melbourne Greater Capital City Statistical Area now covers a larger area than it did in 2006, with the northern boundary having shifted northwards by up to around 40 kilometres ^[See https://maps.abs.gov.au/?xmin=15884115.813179802&ymin=-4689558.173698483&xmax=16551869.692279067&ymax=-4397262.977535984&bottomlayer=ASGS2021:GCCSA&toplayer=ASGC2006:SD].
- There are still many areas, typically in the outer parts of Melbourne, where there is very low or zero transit supply. 
- A similar pattern of higher transit supply near railway lines is evident, but there appears to be more areas with above average or better service levels further out from the centre of the city.
- In general, above average, high and very high service levels appear to be more spread out, especially into the middle suburbs.

Comparing 2016 and 2021 suggests that the geographic spread of service levels has remained largely the same, albeit with some areas that had little to no transit service appearing to have new services.


```{r Greater_Melbourne_2016_2021_year_SI, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = TRUE, fig.fullwidth = TRUE, fig.cap="SI scores by SA3, census day 2016 and 2021"}

si_by_area_2016_2021 <- si_by_area_2016_2021 %>%
  st_drop_geometry()

si_by_area_2016_2021 %>% 
  ggwithinstats( 
 x = Year, 
  y = SI, 
 type = "nonparametric"
  ) 
#+   
#  scale_y_continuous(trans = "log", breaks = c(0.0001, 0.001, 0.01, 0.1, 1, 10, 100, 1000, 10000))


si_by_area_2016_2021 %>% 
  select(SI, Year) %>% 
  tbl_summary(
    by = Year,
    type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c(
      "{mean} ({sd})", 
      "{median} ({p25},{p75})", 
      "{min}, {max}"
    ), 
    missing = "no"
  ) %>% 
  kable()



```


Figure \ref{fig:Greater_Melbourne_2016_2021_year_SI} compares SI scores 
for Greater Melbourne across 2016 and 2021. 
Results indicate a statistically significant difference, 
but there does not appear to have been much change 
across median, mean, interquartile range or overall range (See table) 

Figure \ref{fig:Greater_Melbourne_2016_2021_scatterplot} compares the 2016 and 2021
SI scores for SA1 zones across Greater Melbourne. 
Results indicate a statistically significant relationship, 
and for most SA1 zones it appears that SI scores have remained largely the same in 2021 as they were in 2016. 
Of interest, however, may be a group of SA1s that had SI scores  in the range of 3-4,000 in 2016, but only around 2,500 in 2021.  


@currie2010identifying also reported the distribution of SI scores by category across the number of CCDs and the resident population.  


```{r Greater_Melbourne_2016_2021_sa1_population, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=TRUE, include = TRUE, fig.fullwidth = TRUE, fig.cap="SI scores by SA3, census day 2016 and 2021"}

Greater_Melbourne_2006_SI_population <- tibble(
  "Supply index category" = c(
    "Zero", 
    "Very low", 
    "Low", 
    "Below average", 
    "Above average",  
    "High",
    "Very high"), 
  "Number of areas" = 
    c(189, 1314, 1310, 1294, 608, 535, 589),
  "Population" = 
    c(85423, 793046, 865330, 774521, 324546, 260411, 263832)
)


Greater_Melbourne_2016_2021_SI_count <- si_by_area_2016_2021 %>% 
  na.omit() %>%
  tabyl(SI_binned, Year)

Greater_Melbourne_2006_2016_2021_SI_count <- 
  Greater_Melbourne_2006_SI_population %>% select(`Supply index category`, `Number of areas`)
names(Greater_Melbourne_2006_2016_2021_SI_count) <- c(
  "Supply index category", 
  "2016"
)


#### NEED TO RESOLVE NA VERSUS ZERO ISSUES
Greater_Melbourne_2006_2016_2021_SI_count$`2016` <- Greater_Melbourne_2016_2021_SI_count$`2016`

Greater_Melbourne_2006_2016_2021_SI_count$`2021` <- Greater_Melbourne_2016_2021_SI_count$`2021`

Greater_Melbourne_2021_SI_count <- si_by_area_2016_2021 %>% 
  filter (Year == 2021) %>% 
  tabyl(SI_binned
            )

Greater_Melbourne_2021_SI_count  %>% 
  adorn_totals() %>%
  adorn_pct_formatting() %>%
  kable(caption = "Distribution of supply index categories, by number of SA1 zones for 2021")






### NEED TO OBTAIN 2016 POPULATION VALUES



si_by_areas_and_pop_2021 <- si_by_area_2016_2021 %>% 
  filter (Year == 2021) %>% 
  select(sa1_code_2021, SI, SI_binned)

si_by_areas_and_pop_2021 <- full_join(
  si_by_areas_and_pop_2021, 
  sa1_age_2021 %>% select(`AGEP Age`, Total), 
                          by = join_by(sa1_code_2021 == `AGEP Age`)
)
            





Greater_Melbourne_2021_SI_population <- si_by_area_2016_2021 %>% 
  filter (Year == 2021) %>% 
  tabyl(SI_binned
            )


```


### Social needs

Figure \ref{fig:Greater_Melbourne_2021_social_needs} shows the distribution of categories of social need index scores across Greater Melbourne for 2021. This figure is analogous to the 2006 value from @currie2010identifying shown in Figure \ref{fig:Currie_map_needs} although, as discussed in the methodology section above, it was not possible to exactly replicate the @currie2010identifying approach as the total number of people within one or more of social need component groups (necessary to calculate the two relative need indicators) are not reported in the 2021 census.    

```{r Greater_Melbourne_2021_social_needs, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Distribution of categories of composite social need index scores"}

#join to sa1 data, including lat and long of each sa1
social_2021_sa1_greater_melbourne <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021, sa3_name_2021, cent_lat, cent_long) %>%
    st_drop_geometry(),
  social_2021_sa1 
)

# from https://stackoverflow.com/questions/36817423/how-to-efficiently-calculate-distance-between-pair-of-coordinates-using-data-tab/42014364#42014364
dt.haversine <- function(lat_from, lon_from, lat_to, lon_to, r = 6378137){
  radians <- pi/180
  lat_to <- lat_to * radians
  lat_from <- lat_from * radians
  lon_to <- lon_to * radians
  lon_from <- lon_from * radians
  dLat <- (lat_to - lat_from)
  dLon <- (lon_to - lon_from)
  a <- (sin(dLat/2)^2) + (cos(lat_from) * cos(lat_to)) * (sin(dLon/2)^2)
  return(2 * atan2(sqrt(a), sqrt(1 - a)) * r)
}

social_2021_sa1_greater_melbourne$distance_m_to_GPO <- 
 dt.haversine(-37.813840, 
              144.963028,
              social_2021_sa1_greater_melbourne$cent_lat,
              social_2021_sa1_greater_melbourne$cent_long)


calculate_IRSAD_and_need_index <- function(social_dataset) {
  # scale all to 0 to 100
  social_dataset$IRSAD_100 <- rescale_max(
     social_dataset$IRSAD, to = c(0, 100))
  social_dataset$adult_no_car_100 <- rescale_max(
    social_dataset$adult_no_car, to = c(0, 100))
   social_dataset$accessibility_100 <- rescale_max(
     social_dataset$distance_m_to_GPO, to = c(0, 100))
   social_dataset$over_60_100 <- rescale_max(
     social_dataset$over_60, to = c(0, 100))
   social_dataset$disability_pension_100 <- rescale_max(
     social_dataset$disability_support_pension, to = c(0, 100))
   social_dataset$low_income_families_100 <- rescale_max(
     social_dataset$low_income_families, to = c(0, 100))
  social_dataset$adult_not_labour_force_100 <- rescale_max(
     social_dataset$adult_not_labour_force, to = c(0, 100))
  social_dataset$students_100 <- rescale_max(
     social_dataset$students, to = c(0, 100))
  social_dataset$age_five_to_nine_100 <- rescale_max(
     social_dataset$age_five_to_nine, to = c(0, 100))
  
  # calculate needs scores and scale to 100
  social_dataset$needs_score <- social_dataset$adult_no_car_100 * 0.19 +
    social_dataset$accessibility_100 * 0.15 + 
    social_dataset$over_60_100 * 0.14 + 
    social_dataset$disability_pension_100 * 0.12 + 
    social_dataset$low_income_families_100 * 0.10 + 
    social_dataset$adult_not_labour_force_100 * 0.09 + 
    social_dataset$students_100 * 0.09 + 
    social_dataset$age_five_to_nine_100 * 0.12
  social_dataset$needs_score_100 <- rescale_max(
     social_dataset$needs_score, to = c(0, 100))
  
  # weight IRSAD and needs score by total population
  social_dataset$total_need_IRSAD <- social_dataset$IRSAD *
    social_dataset$population
  social_dataset$total_transport_need <- social_dataset$needs_score * 
    social_dataset$population
  
  # create combined indicator 0 to 100
  social_dataset$combined_needs_index <- social_dataset$total_need_IRSAD + 
    social_dataset$total_transport_need 
  social_dataset$combined_needs_index <- rescale_max(
     social_dataset$combined_needs_index, to = c(0, 100))
  
  
  return(social_dataset %>% 
           select(sa1_code_2021, combined_needs_index, population, sa3_name_2021)) 
}

combined_needs_index_2021_sa1_greater_melbourne <- calculate_IRSAD_and_need_index(
  social_2021_sa1_greater_melbourne)


cuts <- combined_needs_index_2021_sa1_greater_melbourne %>% 
  na.omit() %>% 
  select(combined_needs_index) %>% 
  unlist()  %>% 
  as.vector() %>% 
  quantileCut(6)


cuts <- sapply(str_extract_all(cuts, "-?[0-9.]+"), function(x) max(as.numeric(x))) %>%
  unique() %>% 
  as.numeric() %>% 
  sort()
  
 combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index_binned <- ifelse(
   combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index == 0, NA, ifelse(
      combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index < cuts[1], "Very low", ifelse(
        combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index < cuts[2], "Low", ifelse(
          combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index < cuts[3], "Below average", ifelse(
            combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index < cuts[4], "Above average", ifelse(
              combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index < cuts[5], "High", ifelse(
                combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index >= cuts[5], "Very high", NA)
             )
           )
         )
       )
     )
   ) 

 combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index_binned <- factor( combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index_binned, 
                                         levels = c(
                                           "Very low", 
                                           "Low", 
                                           "Below average",
                                           "Above average", 
                                           "High", 
                                           "Very high"
                                         ))

 
#join to sa1 geometry data
combined_needs_index_2021_sa1_greater_melbourne <- left_join(
  absmapsdata::sa12021 %>% 
    filter(gcc_name_2021 == "Greater Melbourne") %>% 
    select(sa1_code_2021),
  combined_needs_index_2021_sa1_greater_melbourne 
)

 

ggplot()+ 
  geom_sf(data=combined_needs_index_2021_sa1_greater_melbourne %>% na.omit(),
          aes(fill =  combined_needs_index_binned), colour=NA) +
  theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(),
        legend.position="bottom") + #remove y axis ticks
  scale_fill_manual(values = c("#FFFB07", "#CEE102", "#A3CF07", "#61AE09", "#2EA105", "#0A7B01")) #remove y axis ticks


```
Figure \ref{fig:Greater_Melbourne_2021_social_needs} appears to indicate that there is no clear spatial pattern to the distribution of the categories of the composite need index scores. This appears to contrast to trend, albeit with some exceptions, towards very high social needs scores in outer areas identified by @currie2010identifying (Figure \ref{fig:Currie_map_needs}). This may, however, be an artifact of either the differences in the composite needs scores used in this analysis (due to the lack of data to assess relative needs) compared to the @currie2010identifying analysis. As well, the 2021 census SA1 zones generally appear to smalller than the 2006 Census Collection Districts (CCDs) used in @currie2010identifying, especially in outer areas. This will be associated with the growth of Greater Melbourne's population and spatial dispersment, with many of the large outer 'Very High' CCDs shown in the 2006 map now split into many more SA1 zones.  

### Needs-gap analysis


```{r Greater_Melbourne_2021_needs_gap, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Distribution of categories of composite social need index scores"}

combined_needs_index_2021_sa1_greater_melbourne <- 
  left_join(combined_needs_index_2021_sa1_greater_melbourne %>% 
              st_drop_geometry() %>%
              na.omit(), 
            si_by_area_2016_2021 %>% 
              st_drop_geometry() %>% filter(Year == 2021))

combined_needs_index_2021_sa1_greater_melbourne[is.na(combined_needs_index_2021_sa1_greater_melbourne)] <- "Zero" 

combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index_binned <- 
  fct_rev(combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index_binned)

Greater_Melbourne_2021_needs_gap_SA1_count <- tabyl(combined_needs_index_2021_sa1_greater_melbourne, SI_binned, combined_needs_index_binned)

#Greater_Melbourne_2021_needs_gap_SA1_count %>% 
#  adorn_totals(where = c("row", "col")) %>% 
#  adorn_percentages(denominator = "all") %>% 
#  adorn_pct_formatting() %>%
#  adorn_ns() %>% 
#  kable(caption = "Number of SA1 zones by social/transport need and public transport supply category")


Greater_Melbourne_2021_needs_gap_SA1_count_longer <- Greater_Melbourne_2021_needs_gap_SA1_count %>% 
  pivot_longer( 
    cols = 2:7, 
    values_to = "Zones",
    names_to = "Social/transport needs"
  )

Greater_Melbourne_2021_needs_gap_SA1_count_longer$Year <- 2021

```

```{r Greater_Melbourne_2021_needs_gap_percentage, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Distribution of categories of composite social need index scores"}

Greater_Melbourne_2021_needs_gap_SA1_population <- tapply(combined_needs_index_2021_sa1_greater_melbourne$population,
       list(combined_needs_index_2021_sa1_greater_melbourne$SI_binned, combined_needs_index_2021_sa1_greater_melbourne$combined_needs_index_binned), 
       sum) %>% 
  as.data.frame() %>%
  rownames_to_column() 

names(Greater_Melbourne_2021_needs_gap_SA1_population) <- c("Supply Index category", "Very high", "High", "Above average", "Below average", 
                "Low", "Very low")

#Greater_Melbourne_2021_needs_gap_SA1_population %>%
#  adorn_totals(where = c("row", "col")) %>%
#  adorn_percentages(denominator = "all") %>% 
#  adorn_pct_formatting() %>%
#  adorn_ns() %>% 
#  kable(caption = "Population of SA1 zones by social/transport need and public transport supply category")


Greater_Melbourne_2021_needs_gap_SA1_population_longer <- Greater_Melbourne_2021_needs_gap_SA1_population %>% 
  pivot_longer( 
    cols = 2:7, 
    values_to = "Population",
    names_to = "Social/transport needs"
  )

Greater_Melbourne_2021_needs_gap_SA1_population_longer$Year <- 2021
          
```



```{r Greater_Melbourne_2006_2021_needs_gap_zones, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Number of areas by SI and social/transport need category, comparison between 2006 and 2021"}

Greater_Melbourne_2006_needs_gap_SA1_count <- tibble(
  "Supply Index category" = c(
    "Zero", 
    "Very low", 
    "Low", 
    "Below average", 
    "Above average",  
    "High",
    "Very high"), 
  "Very high" = c(89, 190, 209, 189, 74, 53, 53),
  "High" = c(32, 212, 214, 205, 61, 66, 39), 
  "Above average" = c(16, 230, 256, 191, 81, 62, 43), 
  "Below average" = c(18, 245, 221, 261, 121, 92, 75), 
  "Low" = c(25, 218, 217, 237, 116, 98, 146), 
  "Very low" = c(6, 164, 176, 206, 147, 161, 205)
)

#Greater_Melbourne_2006_needs_gap_SA1_count %>% 
#  adorn_totals(where = c("row", "col")) %>%
#  kable()

Greater_Melbourne_2006_needs_gap_SA1_count_longer <- Greater_Melbourne_2006_needs_gap_SA1_count %>% 
  pivot_longer( 
    cols = 2:7, 
    values_to = "Zones",
    names_to = "Social/transport needs"
  )


Greater_Melbourne_2006_needs_gap_SA1_count_longer$Year <- 2006

names(Greater_Melbourne_2021_needs_gap_SA1_count_longer) <- c(
  "Supply Index category",
  "Social/transport needs", 
  "Zones", 
  "Year")

Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer  <- 
  add_row(
    Greater_Melbourne_2006_needs_gap_SA1_count_longer,
    Greater_Melbourne_2021_needs_gap_SA1_count_longer)

Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer$`Supply Index` <- Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer$`Supply Index category` %>% 
  factor(levels = c(
    "Zero", 
    "Very low", 
    "Low", 
    "Below average", 
    "Above average",  
    "High",
    "Very high"
  ))


Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer$`Social/transport needs` <- Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer$`Social/transport needs` %>% 
  factor(levels = c(
    "Very low", 
    "Low", 
    "Below average", 
    "Above average",  
    "High",
    "Very high"
  ))

Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer$`Social/transport needs`

Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer$Year <- Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer$Year %>% as_factor()

grouped_ggbarstats(
  data = Greater_Melbourne_2006_2021_needs_gap_SA1_count_longer,
  x = `Social/transport needs`,
  y = Year,
  counts = Zones,
  grouping.var = `Supply Index category`
)

```


```{r Greater_Melbourne_2006_2021_needs_gap_population, fig.show="hold", echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.fullwidth = TRUE, fig.cap="Population by SI and social/transport need category, comparison between 2006 and 2021"}


Greater_Melbourne_2006_needs_gap_SA1_population <- tibble(
  "Supply Index category" = c(
    "Zero", 
    "Very low", 
    "Low", 
    "Below average", 
    "Above average",  
    "High",
    "Very high"), 
  "Very high" = c(37699, 101305, 137735, 120934, 41702, 27149, 24691),
  "High" = c(14338, 131554, 141273, 119981, 33000, 33314, 16563), 
  "Above average" = c(7985, 140757, 169648, 113281, 43622, 30694, 20393), 
  "Below average" = c(9416, 154876, 146209, 153874, 62783, 42802, 35865), 
  "Low" = c(13263, 140874, 148078, 140390, 60952, 48912, 61719), 
  "Very low" = c(2722, 118926, 119906, 126061, 79117, 76597, 90181)
)



#Greater_Melbourne_2006_needs_gap_SA1_population %>% 
#  adorn_totals(where = c("row", "col")) %>%
#  adorn_percentages(denominator = "all") %>%
#  adorn_pct_formatting() %>% 
#  adorn_ns() %>%
#  kable()


Greater_Melbourne_2006_needs_gap_SA1_population_longer <- Greater_Melbourne_2006_needs_gap_SA1_population %>% 
  pivot_longer( 
    cols = 2:7, 
    values_to = "Population",
    names_to = "Social/transport needs"
  )

Greater_Melbourne_2006_needs_gap_SA1_population_longer$Year <- 2006

Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer  <- 
  add_row(
    Greater_Melbourne_2006_needs_gap_SA1_population_longer,
    Greater_Melbourne_2021_needs_gap_SA1_population_longer)

Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer$`Supply Index category` <- Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer$`Supply Index category` %>% 
  factor(levels = c(
    "Zero", 
    "Very low", 
    "Low", 
    "Below average", 
    "Above average",  
    "High",
    "Very high"
  ))


Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer$`Social/transport needs` <- Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer$`Social/transport needs` %>% 
  factor(levels = c(
    "Very low", 
    "Low", 
    "Below average", 
    "Above average",  
    "High",
    "Very high"
  ))


Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer$Year <- Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer$Year %>% as_factor()

Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer$`Supply Index category` <- Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer$`Supply Index category`%>% 
  as.character()


grouped_ggbarstats(
  data = Greater_Melbourne_2006_2021_needs_gap_SA1_population_longer,
  x = `Social/transport needs`,
  y = Year,
  counts = Population,
  grouping.var = `Supply Index category`
)


```


Figure \ref{fig:Greater_Melbourne_2006_2021_needs_gap_zones} compares the number of zones^[SA1s in 2021, versus CCD in 2006.] by SI and social/transport need category between 2006 and 2021. Population is compared in Figure \ref{fig:Greater_Melbourne_2006_2021_needs_gap_population} 

These results indicate that, in 2021, `r Greater_Melbourne_2021_needs_gap_SA1_count[1,2]` SA1 zones, (representing `r label_percent(accuracy = 0.1)(Greater_Melbourne_2021_needs_gap_SA1_count[1,2]/ sum(Greater_Melbourne_2021_needs_gap_SA1_count[,2:7]))`of the total `r sum(Greater_Melbourne_2021_needs_gap_SA1_count[,2:7]) %>% formatC(big.mark = ",", format = "d")`SA1 zones in Greater Melbourne) had no public transport, but very 'very high' social/transport needs.  These zones have a combined population of 


`r Greater_Melbourne_2021_needs_gap_SA1_population[1,2]` SA1 zones, representing `r Greater_Melbourne_2021_needs_gap_SA1_population[1,2] %>% formatC(big.mark = ",", format = "d")`(`r label_percent(accuracy = 0.1)(Greater_Melbourne_2021_needs_gap_SA1_population[1,2]/ sum(Greater_Melbourne_2021_needs_gap_SA1_population[,2:7]))` of the total `r sum(Greater_Melbourne_2021_needs_gap_SA1_population[,2:7]) %>% formatC(big.mark = ",", format = "d")  ` population) live in areas with no public transport but have 'very high' social/transport needs. This compares to the 89 CCDs (1.6% of the 5,720 total), representing 37,699 Melbourne residents (1.1% of the population) living in areas with no public transport, but very high social/transport needs reported for 2006 in @currie2010identifying. 





## Comparing cases


### Population and equality


# Discussion

## Limitations 

## Directions for furture research

# Conclusions

# References {-}



```{r, include=FALSE}
knitr::write_bib(file = 'packages.bib')
```

